---
title: "FinalProject Question3"
author: "TeamProject"
date: "December 17, 2018"
output:
  html_document:
    df_print: paged
---

```{r setup, warning=FALSE,include=FALSE}
#library(conflicted)
library(kableExtra)
library(tidyverse)
library(readxl)
library(ggplot2)
library(fOptions)
library(dplyr)
library(xts)
library(lubridate)
#conflict_prefer("xcolor", "kableExtra")
knitr::opts_chunk$set(echo = TRUE)
```
##Option Delta Hedging(Real-World)
Delta hedging is an options strategy that aims to reduce, or hedge, the risk associated with price movements in the underlying asset, by offsetting long and short positions. For example, a long call position may be delta hedged by shorting the underlying stock.

Here we are showcasing with an example  how does this  data hedging work as a trading strategy.Also backtesting the same with past 1 year data.

To illustrate this we have chosen Goldman stock Stock price. Let's see how option hedging works as a strategy with this stock.

We have taken  assumptions provided in question for the analysis.
Firstly, we have pooled relevant option price,stock price ,implied volatility of Goldman Sach Group stock.Created data xts object from the data.

```{r Datapooling_creating_xtsobject,echo=FALSE}
OptionsDataInitial <- read_excel("E:/gdrive/MFECourse/FE8828/2018/FE8828-Gaurav_Singh/Group_Assignment/QUESTION 3 FINAL RMD and EXCELFILES/OneYear.xlsx")
Optionsdata<-data.frame(OptionsDataInitial$Date,OptionsDataInitial$Close,OptionsDataInitial$IV30)
Previous_Close<-Optionsdata$OptionsDataInitial.Close
Optionsdata <- na.omit(Optionsdata)
Previous_Close<-na.omit(Previous_Close)
Previous_Close<-tail(Previous_Close,-1)
Optionsdata<-head(Optionsdata,-1)
Optionsdata<-data.frame(Optionsdata,Previous_Close)
names(Optionsdata)[1]="Date"
names(Optionsdata)[2]="Close"
names(Optionsdata)[3]="IV30"
names(Optionsdata)[4]="Previous_Close"
monthnumber<-month(as.Date(Optionsdata$Date)-14)%%12+1
Optionsdata<-data.frame(Optionsdata,monthnumber)
names(Optionsdata)[5]="monthnumber"
xts_obj<-xts(Optionsdata,order.by=Optionsdata[,1])
```
In order to proceed with this trade analysis we have created a dataframe with data column initally.

```{r CREATING_DATAFRAME, echo=FALSE}
dates <- index(xts_obj)
start_date <- min(dates)
end_date <- max(dates)
start_price <- xts_obj[start_date, "Close"]
start_volatility <- xts_obj[start_date, "IV30"]
df <- tibble(date = dates)
df$Close <- coredata(xts_obj[, "Close"])
df$IV30 <- coredata(xts_obj[, "IV30"])
df$Previous_Close<-coredata(xts_obj[, "Previous_Close"])
df$monthnumber<-coredata(xts_obj[, "monthnumber"])
mylist<-list()
mylist1<-list()
vec1<-c()
vec2<-c()
vec3<-c()
vec4<-c()
vec5<-c()
vec6<-c()
sum<-c()
SharpeRatio<-c()
MaxDrawdown<-c()

```

```{r pnl, echo=FALSE}
for (i in 1:12)
{
  MonthlyData<-dplyr::filter(df,as.numeric(monthnumber)==i)
  #mylist1[i]<-list(MonthlyData)
  start_date<-min(MonthlyData$date)
  end_date <- max(MonthlyData$date)
  start_price <- MonthlyData$Close[1]
  start_volatility <- MonthlyData$IV30[1]
  X <- start_price
  sigma = as.numeric(start_volatility)/100
  r <- 0.8 / 100
  b=1.73/100
  Time1 <-as.numeric((end_date - MonthlyData$date)/31536000)
  #vec5[i]<-Time1[1]
  #vec6[i]<-sigma
  quantity=100
  Strike_Price=round(as.numeric(start_price))
  #B = matrix(nrow=12,ncol=20)
  for(j in 1:20)
    {
    vec1[j]<-GBSGreeks("delta", TypeFlag="c", S=as.numeric(MonthlyData$Previous_Close[1]), X=Strike_Price, Time=30/365, r=0.8/100, b=1.73/100, sigma=sigma)-0.4
    vec2[j]=Strike_Price
    Strike_Price=Strike_Price+1
    }
  Strike_Price=vec2[which.min(abs(vec1))]
  #vec4[i]<-MonthlyData$Previous_Close[1]
  #vec3[i]<-Strike_Price
  df_opt <-mutate(MonthlyData,premium=GBSOption(TypeFlag = "c",
                                       S = as.numeric(Previous_Close),
                                       X =Strike_Price,
                                       Time =Time1,
                                       r=r,
                                       b=b,
                                       sigma=sigma)@price)%>%
    ungroup%>%mutate(Option_DoD_PnL = ifelse(date == start_date,
                                             premium * (-1)*quantity,
                                             (premium*quantity) - dplyr::lag(premium*quantity)))
  df_opt <-mutate(df_opt,delta_hedge = round(GBSGreeks("delta", TypeFlag= "c", S = as.numeric(MonthlyData$Previous_Close),  X =Strike_Price, Time=Time1, r=r,
                                                       b=b, sigma=sigma) *
                                               quantity * (-1)))
  
  df_opt <-mutate(df_opt,Hedging_DoD_Pnl = ifelse(date == start_date,(delta_hedge * (as.numeric(Close) - (as.numeric(Previous_Close)))),(delta_hedge * (as.numeric(Close) - dplyr::lag(as.numeric(Close))))))
  df_opt<-mutate(df_opt,Net_PnL = Option_DoD_PnL + Hedging_DoD_Pnl)
  
  
   sum[i]<- sum(df_opt$Net_PnL)
    #We Assume a Self Financing Portfolio where the initial investment will be the cost of the option - cash inflow from shorting delta shares
  SharpeRatio[i]<-((sum[i]/(-1*df_opt$Net_PnL[1]))-(r*100))/stdev(cumsum(df_opt$Net_PnL))
  MaxDrawdown[i]<-mutate(df_opt,PnL=cumsum(Net_PnL))%>%{
    xs<- .$PnL
    max(cummax(xs)-cummin(xs))
  }
  mylist[i]<-list(df_opt)
  
}

```
#TradeAnalysis Monthwise
#Dec-Jan
```{r tradeanalysismonthwise,echo=FALSE}

knitr::kable(
mylist[1]
)%>%kableExtra::kable_styling(full_width=F,position="left")

mutate(df_opt,PnL = cumsum(Hedging_DoD_Pnl)) %>%
{
  xs <- .$PnL
  max(cummax(xs) - cummin(xs))
}

MonthWise<-data.frame(mylist[1])
ggplot()+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Option_DoD_PnL),color="red")+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Hedging_DoD_Pnl),color="blue")+
  scale_x_reverse()+labs(title = "Stock and Option PNL",x = "Time to Expiry", y = "Option(red) and Stock(blue) PnL ") 
ggplot()+
  geom_line(color="red") + 
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Net_PnL),color="blue") +scale_x_reverse()+
  labs(title = "Net PnL December-January",x = "Time to Expiry", y = "Net PnL")
paste(cat("Final Net cumulative profit for this month ",sum(MonthWise$Net_PnL)))

```
# MONTH JAN-FEB
```{r Feb,echo=FALSE}

MonthWise<-data.frame(mylist[2])
knitr::kable(
mylist[2]
)%>%kableExtra::kable_styling(full_width=F,position="left")
ggplot()+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Option_DoD_PnL),color="red")+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Hedging_DoD_Pnl),color="blue")+
  scale_x_reverse()+labs(title = "Stock and Option PNL",x = "Time to Expiry", y = "Option(red) and Stock(blue) PnL ") 
ggplot()+
  geom_line(color="red") + 
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Net_PnL),color="blue") +scale_x_reverse()+
  labs(title = "Net PnL January-Febraury",x = "Time to Expiry", y = "Net PnL")
paste(cat("Final Net cumulative profit for this month ",sum(MonthWise$Net_PnL)))
```

#MONTH FEB-MARCH

```{r March,echo=FALSE}
MonthWise<-data.frame(mylist[3])
knitr::kable(
mylist[3]
)%>%kableExtra::kable_styling(full_width=F,position="left")

ggplot()+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Option_DoD_PnL),color="red")+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Hedging_DoD_Pnl),color="blue")+
  scale_x_reverse()+labs(title = "Stock and Option PNL",x = "Time to Expiry", y = "Option(red) and Stock(blue) PnL ") 
ggplot()+
  geom_line(color="red") + 
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Net_PnL),color="blue") +scale_x_reverse()+
  labs(title = "Net PnL Febraury-March",x = "Time to Expiry", y = "Net PnL")
paste(cat("Final Net cumulative profit for this month ",sum(MonthWise$Net_PnL)))
```

#MONTH MARCH-APRIL

```{r April,echo=FALSE}
MonthWise<-data.frame(mylist[4])
knitr::kable(
mylist[4]
)%>%kableExtra::kable_styling(full_width=F,position="left")
ggplot()+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Option_DoD_PnL),color="red")+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Hedging_DoD_Pnl),color="blue")+
  scale_x_reverse()+labs(title = "Stock and Option PNL",x = "Time to Expiry", y = "Option(red) and Stock(blue) PnL ") 
ggplot()+
  geom_line(color="red") + 
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Net_PnL),color="blue") +scale_x_reverse()+
  labs(title = "Net PnL March-April",x = "Time to Expiry", y = "Net PnL")
paste(cat("Final Net cumulative profit for this month ",sum(MonthWise$Net_PnL)))
```

#MONTH APRIL-MAY

```{r May,echo=FALSE}
MonthWise<-data.frame(mylist[5])
knitr::kable(
mylist[5]
)%>%kableExtra::kable_styling(full_width=F,position="left")
ggplot()+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Option_DoD_PnL),color="red")+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Hedging_DoD_Pnl),color="blue")+
  scale_x_reverse()+labs(title = "Stock and Option PNL",x = "Time to Expiry", y = "Option(red) and Stock(blue) PnL ") 
ggplot()+
  geom_line(color="red") + 
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Net_PnL),color="blue") +scale_x_reverse()+
  labs(title = "Net PnL for April-May",x = "Time to Expiry", y = "Net PnL")
paste(cat("Final Net cumulative profit for this month ",sum(MonthWise$Net_PnL)))
```

#MONTH MAY-JUNE

```{r June,echo=FALSE}


MonthWise<-data.frame(mylist[6])
knitr::kable(
mylist[6]
)%>%kableExtra::kable_styling(full_width=F,position="left")
ggplot()+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Option_DoD_PnL),color="red")+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Hedging_DoD_Pnl),color="blue")+
  scale_x_reverse()+labs(title = "Stock and Option PNL",x = "Time to Expiry", y = "Option(red) and Stock(blue) PnL ") 
ggplot()+
  geom_line(color="red") + 
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Net_PnL),color="blue") +scale_x_reverse()+
  labs(title = "Net PnL May-June",x = "Time to Expiry", y = "Net PnL")
paste(cat("Final Net cumulative profit for this month ",sum(MonthWise$Net_PnL)))
```
#MONTH JUNE-JULY

```{r July,echo=FALSE}
MonthWise<-data.frame(mylist[7])
knitr::kable(
mylist[7]
)%>%kableExtra::kable_styling(full_width=F,position="left")
ggplot()+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Option_DoD_PnL),color="red")+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Hedging_DoD_Pnl),color="blue")+
  scale_x_reverse()+labs(title = "Stock and Option PNL",x = "Time to Expiry", y = "Option(red) and Stock(blue) PnL ") 
ggplot()+
  geom_line(color="red") + 
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Net_PnL),color="blue") +scale_x_reverse()+
  labs(title = "Net PnL June-July",x = "Time to Expiry", y = "Net PnL")
paste(cat("Final Net cumulative profit for this month ",sum(MonthWise$Net_PnL)))
```

#MONTH JULY-AUGUST
```{r August,echo=FALSE}
MonthWise<-data.frame(mylist[8])
knitr::kable(
mylist[8]
)%>%kableExtra::kable_styling(full_width=F,position="left")
ggplot()+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Option_DoD_PnL),color="red")+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Hedging_DoD_Pnl),color="blue")+
  scale_x_reverse()+labs(title = "Stock and Option PNL",x = "Time to Expiry", y = "Option(red) and Stock(blue) PnL ") 
ggplot()+
  geom_line(color="red") + 
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Net_PnL),color="blue") +scale_x_reverse()+
  labs(title = "Net PnL July-August",x = "Time to Expiry", y = "Net PnL")
paste(cat("Final Net cumulative profit for this month ",sum(MonthWise$Net_PnL)))
```

#MONTH AUGUST-SEPTEMBER
```{r Sept,echo=FALSE}
MonthWise<-data.frame(mylist[9])
knitr::kable(
mylist[9]
)%>%kableExtra::kable_styling(full_width=F,position="left")
ggplot()+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Option_DoD_PnL),color="red")+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Hedging_DoD_Pnl),color="blue")+
  scale_x_reverse()+labs(title = "Stock and Option PNL",x = "Time to Expiry", y = "Option(red) and Stock(blue) PnL ") 
ggplot()+
  geom_line(color="red") + 
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Net_PnL),color="blue") +scale_x_reverse()+
  labs(title = "Net PnL August-September",x = "Time to Expiry", y = "Net PnL")
paste(cat("Final Net cumulative profit for this month ",sum(MonthWise$Net_PnL)))
```

#MONTH SEPTEMBER-OCTOBER

```{r Oct,echo=FALSE}
MonthWise<-data.frame(mylist[10])
knitr::kable(
mylist[10]
)%>%kableExtra::kable_styling(full_width=F,position="left")
ggplot()+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Option_DoD_PnL),color="red")+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Hedging_DoD_Pnl),color="blue")+
  scale_x_reverse()+labs(title = "Stock and Option PNL",x = "Time to Expiry", y = "Option(red) and Stock(blue) PnL ") 
ggplot()+
  geom_line(color="red") + 
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Net_PnL),color="blue") +scale_x_reverse()+
  labs(title = "Net PnL December-October",x = "Time to Expiry", y = "Net PnL")
paste(cat("Final Net cumulative profit for this month ",sum(MonthWise$Net_PnL)))
```

#MONTH OCTOBER-NOVEMBER
```{r Nov,echo=FALSE}
MonthWise<-data.frame(mylist[11])
knitr::kable(
mylist[11]
)%>%kableExtra::kable_styling(full_width=F,position="left")
ggplot()+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Option_DoD_PnL),color="red")+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Hedging_DoD_Pnl),color="blue")+
  scale_x_reverse()+labs(title = "Stock and Option PNL",x = "Time to Expiry", y = "Option(red) and Stock(blue) PnL ") 
ggplot()+
  geom_line(color="red") + 
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Net_PnL),color="blue") +scale_x_reverse()+
  labs(title = "Net PnL October-November",x = "Time to Expiry", y = "Net PnL")
paste(cat("Final Net cumulative profit for this month ",sum(MonthWise$Net_PnL)))
```

#MONTH NOVEMBER-DECEMBER
```{r Dec,echo=FALSE}
MonthWise<-data.frame(mylist[12])
knitr::kable(
mylist[12]
)%>%kableExtra::kable_styling(full_width=F,position="left")
ggplot()+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Option_DoD_PnL),color="red")+
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Hedging_DoD_Pnl),color="blue")+
  scale_x_reverse()+labs(title = "Stock and Option PNL",x = "Time to Expiry", y = "Option(red) and Stock(blue) PnL ") 
ggplot()+
  geom_line(color="red") + 
  geom_line(aes(x=(max(MonthWise$date)-MonthWise$date)/86400,y=MonthWise$Net_PnL),color="blue") +scale_x_reverse()+
  labs(title = "Net PnL November-December",x = "Time to Expiry", y = "Net PnL")
paste0(cat("Final Net cumulative profit for this month ",sum(MonthWise$Net_PnL)))
```

# SHARPE RATIO wrt MONTH, MAX DRAWDOWN wrt MONTH

###Sharpe ratio is below zero indicating poor performance of this particular strategy.
###From MaxDrawDown graph we don't see any clear pattern to infer .
```{r Sharpe_MaxDrawDownPlots,echo=FALSE }
datevector<-c("December","January","February","March","April","May","June","July","August","September","October","November")
ggplot()+
  geom_point(aes(x=datevector,y=SharpeRatio),color="red")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggplot()+
geom_point(aes(x=datevector,y=MaxDrawdown),color="blue")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

#CHANGING DELTA
###Here we repeat backtesting procedure for entire year of data by changing delta and seeing how the net PnL changes.
###OBSERVATION:As delta increases Net profit for this hedging strategy declines gradually . According to data, delta hedging works better with options that are most out of the money.

```{r checkingfordiffdeltas,echo=FALSE}
delta1<-0
datevec<-c()
vec5<-c()
vec6<-c()
vec3<-c()
vec4<-c()
vec1<-c()
vec2<-c()
finalsum<-c()
for(k in 1:12)
{
  delta1<-k/20
  for (i in 1:12)
  {
    MonthlyData<-dplyr::filter(df,as.numeric(monthnumber)==i)
    #mylist1[i]<-list(MonthlyData)
    start_date<-min(MonthlyData$date)
    end_date <- max(MonthlyData$date)
    #datevec[i]<-as.Date(max(MonthlyData$date))
    start_price <- MonthlyData$Close[1]
    start_volatility <- MonthlyData$IV30[1]
    X <- start_price
    sigma = as.numeric(start_volatility)/100
    r <- 0.8 / 100
    b=1.73/100
    Time1 <-as.numeric((end_date - MonthlyData$date)/31536000)
    vec5[i]<-Time1[1]
    vec6[i]<-sigma
    quantity=100
    Strike_Price=round(as.numeric(start_price))
    #B = matrix(nrow=12,ncol=20)
    for(j in 1:50)
    {
      vec1[j]<-GBSGreeks("delta", TypeFlag="c", S=as.numeric(MonthlyData$Previous_Close[1]), X=Strike_Price, Time=Time1[1], r=0.8/100, b=1.73/100, sigma=sigma)-delta1
      vec2[j]=Strike_Price
      Strike_Price=Strike_Price+1
    }
    Strike_Price=vec2[which.min(abs(vec1))]
    #Strike_Price=round(as.numeric(start_price))
    vec4[i]<-MonthlyData$Previous_Close[1]
    vec3[i]<-Strike_Price
    df_opt <-mutate(MonthlyData,premium=GBSOption(TypeFlag = "c",
                                                  S = as.numeric(Previous_Close),
                                                  X =Strike_Price,
                                                  Time =Time1,
                                                  r=r,
                                                  b=b,
                                                  sigma=sigma)@price)%>%
      ungroup%>%mutate(Option_DoD_PnL = ifelse(date == start_date,
                                               premium * (-1)*quantity,
                                               (premium*quantity) - dplyr::lag(premium*quantity)))
    
    #GBSGreeks("delta", TypeFlag= "c", S = as.numeric(MonthlyData$Previous_Close),  X =Strike_Price, Time=Time1, r=r,
    #b=b, sigma=sigma)
    df_opt <-mutate(df_opt,delta_hedge = round(GBSGreeks("delta", TypeFlag= "c", S = as.numeric(MonthlyData$Previous_Close),  X =Strike_Price, Time=Time1, r=r,
                                                         b=b, sigma=sigma) *
                                                 quantity * (-1)))
    
    df_opt <-mutate(df_opt,Hedging_DoD_Pnl = ifelse(date == start_date,(delta_hedge * (as.numeric(Close) - (as.numeric(Previous_Close)))),(delta_hedge * (as.numeric(Close) - dplyr::lag(as.numeric(Close))))))
    df_opt<-mutate(df_opt,Net_PnL = Option_DoD_PnL + Hedging_DoD_Pnl)
    sum[i]<-sum(df_opt$Net_PnL)
    #We Assume a Self Financing Portfolio where the initial investment will be the cost of the option - cash inflow from shorting delta shares
    SharpeRatio[i]<-((sum[i]/(-1*df_opt$Net_PnL[1]))-(r*100))/stdev(cumsum(df_opt$Net_PnL))
    MaxDrawdown[i]<-mutate(df_opt,PnL=cumsum(Net_PnL))%>%{
      xs<- .$PnL
      max(cummax(xs)-cummin(xs))
    }
    
    mylist[i]<-list(df_opt)
    #max(cummax(df_opt$Net_PnL)-cummin(df_opt$Net_PnL))
  }
  finalsum[k]=sum(sum)
}

ggplot()+
  geom_point(aes(x=c(rep(seq(0.05,0.6,0.05))),y=finalsum),color="red")+
  labs(title = "Total Profit over a year for a Particular Delta" ,x= "Delta", y = "Total Net Profit")

```