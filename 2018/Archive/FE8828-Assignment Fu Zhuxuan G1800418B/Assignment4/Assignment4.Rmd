---
title: "Assignment4"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(knitr)
library(gridExtra)
knitr::opts_chunk$set(echo = TRUE, fig.align="center", collapse = TRUE, cache = T)
bank <- read.csv("https://goo.gl/PBQnBt", sep = ";")
```

## Finding #1
To plot the average balance against age in different marital status groups:  
1. Majority of the clients have balance less than 10,000 euro.  
2. Majority of clients are married.    
3. Divorced clients have less balance than married and single clients.  

```{r Finding1, echo = TRUE}
ggplot(data = bank) +
  geom_point(mapping = aes(x = age, y = balance)) + 
  facet_grid( ~ marital)+
  labs(x='Age', y='Balance')
```

## Finding #2
To find the relationship between education and credit default rate:  
1.The clients with secondary education level have the highest credit default rate as 1.99%.  
2.The clients with teritary education level have the lowest credit default rate, with possible explaination being they are well educated and have higher average income.  
3.In general, the credit default rate is very low.
```{r Finding2, echo = TRUE}
lvls <- names(sort(tapply(bank$default == "yes", bank$education, mean)))
ggplot(data = bank) +
  geom_bar(aes(factor(education, levels = lvls), fill = default), position = "fill") +
  geom_text(data = group_by(bank, education) %>%
               summarize(default_rate = sum(default=='yes')/n()) %>%ungroup,
               aes(x = education, y = default_rate, label=paste0(format(round(default_rate*100, 2), nsmall = 2),'%')), inherit.aes = FALSE,size=3) +
  labs(x = "Education", y="Credit Defulat Rate") +
  scale_y_continuous(labels = scales::percent)
```

## Finding #3
The clients are devided into three balance levels with equal number of clients in each group. Then we analyze the age distribution of each balance level group.  
We noticed that, the higher balance level is, the older the group is. However, interestingly, the average age of middle balance level is less than low balance level group.
```{r Finding3, echo = TRUE}
bank %>%
  mutate(balance_level = ifelse(ntile(balance, 3)==3, 'high',ifelse(ntile(balance, 3)==2,'middle','low'))) -> res
ggplot(res) +
  geom_boxplot(aes(x = factor(balance_level, levels = c('low','middle','high')), y=age, fill=factor(balance_level, levels = c('low','middle','high'))), alpha = 0.3)+
  labs(x = "Balance Level", y="Age")+
  # the range for balance levels is from Assginment3 Finding #7
  scale_fill_discrete(name="Balance Level",
                         breaks=c("low", "middle", "high"),
                         labels=c("low (-3313 euro to 174 euro)", "middle (174 euro - 979 euro)", "high (980 euro - 71188 euro)"))
```


## Finding #4
When analysing the relationship beween balance and age, we look at the group with housing and without housing separately. For the group without housing, there isn't obvious trend between age and balance. However, for the group with housing, for clients older than 60, there shows positive relationship between balance and age.
```{r Finding4, echo = TRUE}
ggplot(bank, aes(age, balance, color = housing, alpha=0.2)) + 
  geom_point() + 
  geom_smooth() +
  scale_alpha_continuous(guide = FALSE)
```

## Finding #5
This chart is to analyze the relationship between education level and marital status.  
1.The higher education level is, the percentage of single is higher.  
2.The divorce rate is around the same among different education group.
```{r Finding5, echo = TRUE}
ggplot(bank) + 
  geom_bar(mapping = aes(x=education, fill = marital), position = "fill") +
  scale_y_continuous(labels = scales::percent)+
  coord_flip()+
  labs(y= "Percentage", x = "Education")
```

## Finding #6
To investigate the relationship between people's age and the duration of last call time.  
1. We noticed that middle aged group (40's and 50's) took shortest call during the last contact. This may be explained that middle aged group are mostly busy with work or family, hence less time for salesperson from the bank.  
2. When plotting the average point together with the boxplot, we noticed that the average value are all above median line. This shows that the majority of the clients have very short call duration.  
3. We noticed that all clients with call duration more than 750 sec (12.5 mins) are mostly recognized as outliers.
```{r Finding6, echo = TRUE}
ggplot(data = bank %>% mutate(ageGroup = (age %/% 10) * 10), 
  aes(ageGroup, duration, group = ageGroup)) +
  geom_boxplot() +
  stat_summary(fun.y = mean,geom = "point", colour="green") +
  labs(y= "Last Call Duration (sec)", x = "Age Group")
```

## Finding #7
After finding 6, we would like to further analyze the relationship between call duration and term deposit subscription rate, together with balance level:  
1.In the plot of balance again duration, we noticed that balance is negatively related to call duration. The longer call duration is, the less balance they have.  
2.In the point plot, we noticed that green points (subscribed client) are mainly distributed on the right side (longer call duration). Hence, we further segregate customers into groups by call duration and plot the bar chart against subscription rate.  
3.The call duartion is positively related to the term deposit subscription rate. People take long call when they are interested in the product or they are successfully persuaded by salesperson.
```{r Finding7, echo = TRUE}
p1 <- ggplot(bank)+
  geom_point(aes(duration, balance, color=y, alpha=0.05))+
  scale_alpha_continuous(guide = FALSE)+
  labs(x='Call Duration (sec)', y='Balance')+
  # two graph could share same legend
  scale_color_discrete(guide=FALSE)

bank %>%
  mutate(duration_level = ifelse(duration<600,'0-10 mins',ifelse(duration<1200,'10-20 mins','20 mins or more'))) -> res
p2 <- ggplot(res)+
  geom_bar(aes(duration_level, fill = y), position = "fill")+
  scale_y_continuous(labels = scales::percent)+
  labs(x='Call Duration',y='Term Deposit Subscription Rate')+
  scale_fill_discrete(name="Term Deposit Subscribed")+
  theme(legend.position = "top")

grid.arrange(p1, p2, ncol=1, nrow=2)
```

## Finding #8
To find the relationship between default rate and job:  
1.The entrepreneurs have the highest credit default rate. This may be explained that the risk of running one's own business is high.  
2.The unemployed clients have the second highest credit default rate, reason being they don't have stable income.  
3.Students have the smallest population and the lowest default rate.  
4.Unemployed, services and blue-collar clients have very low balance.
```{r Finding8, echo = TRUE}
bank%>% 
  filter(job!="unknown") %>%
  group_by(job) %>% 
  summarise(average_balance = mean(balance),no_of_client = n(), `default_rate(%)` = sum(default=='yes')/n()*100) -> res
ggplot(res, aes(x=average_balance, y=`default_rate(%)`, color = job, alpha = 0.7, size = no_of_client)) +
  geom_point()+
  scale_size_continuous(guide = FALSE, range = c(3, 12)) +
  labs(x = "Average Balance", y="Default Rate (%)", title="Number of client shown inside the circles")+
  scale_alpha_continuous(guide = FALSE)+
  geom_text(aes(label = no_of_client, size = 5))
```

## Finding #9
Firstly, we filtered data where education and contact is not unknown. Then via plotting the polar chart of age against contact method, segregated by education level:  
1.Clients with teritiary education have highest rate of using cellular phone as last contact method.  
2.The usage of telephone is most common in old group (above 65 years old).
```{r Finding9, echo = TRUE}
bank%>%
  filter(contact != 'unknown' & education!='unknown') -> res
ggplot(res) + 
  geom_bar(mapping = aes(x = age, fill = contact), position = "fill") + 
  coord_polar()+
  facet_grid(. ~education)+
  scale_y_continuous(labels = scales::percent)
```

## Finding #10
This is to study the relationship between job and marital status:  
1.Retired people have highest divorce rate as 18.7%. One potential reason is that the average age of retired people is largest.  
2.Unemployed clients also have high rate of divorce. It may be explained by that they don't have stable income to sustain a stable family.  
3.From finding 8, we noticed that both services and blue-collar have similar balance and default rate, however these two groups have very different divorce rate. Services group has much higher divorce rate compared to blue-collar group.
```{r Finding10, echo = TRUE}
lvls <- names(sort(tapply(bank$marital == "divorced", bank$job, mean)))
ggplot(data = bank, aes(x=factor(job, levels=lvls), fill = marital)) +
  geom_bar() +
  geom_text(data = group_by(bank, job) %>%
               summarize(divorce_rate = sum(marital=='divorced')/n()*1000) %>%ungroup,
               aes(x = job, y = divorce_rate, label=paste0(format(round(divorce_rate/10, 2), nsmall = 2),'%')), size=2,inherit.aes = FALSE, hjust = -0.2, nudge_x = 0) +
  geom_point(data = group_by(bank, job) %>%
               summarize(divorce_rate = sum(marital=='divorced')/n()*1000) %>%ungroup,
               aes(x = job, y = divorce_rate), inherit.aes = FALSE,alpha =0.5)+
  scale_y_continuous(sec.axis = sec_axis(~./1000, labels = scales::percent,name='Divorce Rate'))+
  labs(x="Job sorted according to divorce rate\n (Top - higher)", y="Number of Clients") +
  coord_flip()
```