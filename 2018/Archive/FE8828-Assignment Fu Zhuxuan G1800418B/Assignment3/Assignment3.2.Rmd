---
title: "Assignment3.2"
output: html_document
---


```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(bizdays)
library(knitr)
library(kableExtra)
library(ggplot2)
library(formattable)
# Use echo = TRUE for assignment is an exception, so code is visible. 
knitr::opts_chunk$set(echo = TRUE, fig.align="center", collapse = TRUE, cache = TRUE) 
bank <- read.csv("https://goo.gl/PBQnBt", sep = ";")
```

## Finding #1

This data contains `r nrow(bank)` rows and `r ncol(bank)` columns.

## Finding #2

Marital status of bank customers:
```{r Finding2, echo = FALSE}
bank %>%  
  group_by(marital) %>% 
  summarize(no_of_client=n())%>%
  arrange(desc(no_of_client)) -> res
ggplot(res, aes(x=marital, y=no_of_client)) +
  geom_bar(stat = "identity")+
  labs(x = "Marital Status", y="Number of Clients")
res%>%
  kable()%>%
  kable_styling(bootstrap_options = c("striped"),full_width = F, position = "center")

```

## Finding #3
Education level of bank customers:
```{r Finding3, echo=FALSE}
# Find the major education group 
bank %>%
  group_by(education) %>% 
  summarise(no_of_client = n()) %>% 
  arrange(desc(no_of_client)) -> res
msg <- paste0( "The education group with most client is ", res[["education"]][1], ", with ", res[["no_of_client"]][1], " clients." )
msg
ggplot(res, aes(x=education, y=no_of_client)) +
  geom_bar(stat = "identity")+
  labs(x = "Education Level", y="Number of Clients")
res%>%
  kable()%>%
  kable_styling(bootstrap_options = c("striped"),full_width = F, position = "center")

```

## Finding #4
Summarize account balance, the number of client, default rate by occupation. And find the occupation with highest and lowest average balance.  
Observations:  
1. Entrepreneurs are mostly likely to default.  
2. Retired clients have highest average balance.
```{r Finding4, echo=FALSE}
bank %>%
  group_by(job) %>% 
  summarise(average_balance = format(round(mean(balance),2),nsmall=2),no_of_client = n(),  `default_rate(%)` = format(round(sum(default=='yes')/n()*100,2),nsmall=2)) %>% 
  arrange(desc(average_balance))-> res
msg <- paste0( "The occupation with highest average account balance is ", res[["job"]][1], ", with ", res[["average_balance"]][1], " Euros. ","The occupation with least average balance is ", res[["job"]][length(res[["job"]])], ", with ", res[["average_balance"]][length(res[["job"]])], " Euros. ")
msg
ggplot(res, aes(x=job, y= `default_rate(%)`)) +
  geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  labs(x = "Job", y="Credit Defulat Rate (%)")

res%>%mutate(`default_rate(%)` = color_tile("white", "red")(`default_rate(%)`), average_balance =
               color_tile("white", "green")(average_balance)) -> res
res%>%
  kable(format = "html", escape = F)%>%
  kable_styling(bootstrap_options = c("striped"),full_width = F, position = "center")

```

## Finding #5
Filter out all the data which have not any column shown as "unknown" and show how many such clients we have:
```{r Finding5, echo=FALSE}
# Find the major education group 
bank %>%
  filter(age!="unknown" &job!="unknown" &marital!="unknown" &education!="unknown" &default!="unknown" &balance!="unknown" &housing!="unknown" &loan!="unknown" &contact!="unknown" &day!="unknown" &month!="unknown" &duration!="unknown" &campaign!="unknown" &pdays!="unknown" &previous!="unknown" &poutcome!="unknown" &y!="unknown" ) -> res

msg <- paste0( "Out of ", nrow(bank), " clients' data, there are ", nrow(res), " clients with all fields data known." )
msg
```

## Finding #6
Are people with high education level less likely to default?  
Observation:  
Default rate is not strictly negatively related with education level. Although teritary group indeed has lowest default rate, secondary group has highest default rate, instead of primary group.
```{r Finding6, echo=FALSE}
bank%>% 
  filter(education!="unknown") %>%
  group_by(education) %>% 
  summarise(average_balance = mean(balance),no_of_client = n(), `default_rate(%)` = sum(default=='yes')/n()*100) %>% 
  arrange(desc(`default_rate(%)`)) -> res
res%>%
  kable()%>%
  kable_styling(bootstrap_options = c("striped"),full_width = F, position = "left")
```

## Fingding #7
Segregate the data by low, middle or high balance level and age group and observe the balance data.  
Observations:  
1. When balance level is same, the difference between lowest balance and highest balance is larger in older age group. It hints that when people gets older, the gap between rich and poor is also larger.  
2. When balance level is same, average balance is higher for older age group.  
3. The balance difference is smallest in middle balance level and balance difference is largest in high balance level group.  
4. Middle aged group (31-55) has most number of clients.  
```{r Finding7, echo=FALSE}

bank %>%
  mutate(balance_level = ifelse(ntile(balance, 3)==3, 'high',ifelse(ntile(balance, 3)==2,'middle','low')), age_group = ifelse(age<30, 'young',ifelse(age<=55,'middle aged','old'))) %>%
  group_by(balance_level, age_group) %>%
  summarise(no_of_clients = n(), balance_mean = format(round(mean(balance),2), nsmall = 2), balance_difference = max(balance) - min(balance), lowest_balance = min(balance), highest_balance = max(balance)) %>%
  arrange(factor(balance_level, levels = c('low','middle','high')), factor(age_group, levels = c('young', 'middle aged','old'))) -> res

res %>%
  unite(balance_age_group, balance_level, age_group) -> unite_res
unite_res %>%
  kable()%>%
  kable_styling(bootstrap_options = c("striped"),full_width = F, position = "left")

```

## Fingding #8
The relationship between marital status, housing owning status and loan rate, term deposit subscription rate.  
Observations:  
1. The clients who own housing are less likely to subscribe the term deposit.   
2. Divorced group is the poorest group among three marital status.   
```{r Finding8, echo=FALSE}
bank %>%
  group_by(marital, housing) %>%
  summarise(`loan_rate(%)` = format(round(sum(loan == 'yes')/n()*100,2), nsmall = 2), `deposit_subscription_rate(%)` = format(round(sum(y == 'yes')/n()*100,2), nsmall = 2), ave_balance = mean(balance)) -> res
res%>%
  kable()%>%
  kable_styling(bootstrap_options = c("striped"),full_width = F, position = "left")
```

## Fingding #9
Using bind_cols and bind_rows to summarize the seasonal impact on call duration and product subscription rate.  
Oberservations:  
1. Call duration is longest in winter and shortest in autumn. But ingeneral, the call durations among four seasons are similar, which shows no obvious season impact on the call duration.  
2. Clients that were last contacted in Autumn have highest product subscription rate.
```{r Finding9, echo=FALSE}
spring <- filter(bank, month == "mar" |month == "apr"|month == "may")%>%
  summarize(Spring = mean(duration))
summer <- filter(bank, month == "jun" |month == "jul"|month == "aug")%>%
  summarize(Summer = mean(duration))
autumn <- filter(bank, month == "aug" |month == "sep"|month == "oct")%>%
  summarize(Autumn = mean(duration))
winter <- filter(bank, month == "nov" |month == "dec"|month == "jan")%>%
  summarize(Winter = mean(duration))
spring2 <- filter(bank, month == "mar" |month == "apr"|month == "may")%>%
  summarize(Spring = sum(y=='yes')/n()*100)
summer2 <- filter(bank, month == "jun" |month == "jul"|month == "aug")%>%
  summarize(Summer = sum(y=='yes')/n()*100)
autumn2 <- filter(bank, month == "aug" |month == "sep"|month == "oct")%>%
  summarize(Autumn = sum(y=='yes')/n()*100)
winter2 <- filter(bank, month == "nov" |month == "dec"|month == "jan")%>%
  summarize(Winter = sum(y=='yes')/n()*100)
res1 <- bind_cols(spring, summer, autumn, winter)
res2 <- bind_cols(spring2, summer2, autumn2, winter2)
res <- bind_rows(res1, res2)
info_type <- c('call duration', 'term deposit subscription rate(%)')
new_col <- data.frame(info_type)
res <- bind_cols(new_col, res)
res %>%
  kable()%>%
  kable_styling(bootstrap_options = c("striped"),full_width = F, position = "left")

```

## Fingding #10
Total and subtotal for the relationship between job and usage of cellular phone/telephone.  
Observations:  
1. Self-employed clients are mostly using cellular as contact method, instead of telephone. One possible hint is that self-employed people are more mobile than other occupations.  
2. Retired clients are mostly using telephone instead of cellular. One possible hint is that retired poeple are usually old, hence use telephone more than cellular.
3. In general, celluar is much more prevalent than telephone (almost 10 times the usage) as contact method. 
```{r Finding10, echo=FALSE}
bank %>%
  filter(contact !='unknown')%>%
  group_by(job)%>%
  summarize(cellular = sum(contact =='cellular'), telephone = sum(contact == 'telephone'))-> res
res$job <- as.character(res$job)
bank %>%
  filter(contact !='unknown')%>%
  mutate(cellular = sum(contact =='cellular'), telephone = sum(contact == 'telephone'))%>%
  select(cellular, telephone)%>%
  distinct(cellular, telephone)->row_total
# sapply(res, class)
# sapply(row_total, class)
res1 <- bind_rows(res, row_total)
res1$job[[nrow(res1)]] <- 'Total'

res1 %>%
  mutate(`cellular/telephone ratio` = format(round(cellular/telephone,2),nsmall = 2), Total = cellular + telephone )%>%
  arrange()-> final_res

final_res%>%
  mutate(`cellular/telephone ratio` = cell_spec(`cellular/telephone ratio`, "html", color
                                       =ifelse(`cellular/telephone ratio`==max(`cellular/telephone ratio`), "green", ifelse(`cellular/telephone ratio`==min(`cellular/telephone ratio`), "red", "black")))) -> final_res

final_res %>%
  kable(format = "html", escape = F)%>%
  kable_styling(bootstrap_options = c("striped"),full_width = F, position = "left")
```