---
title: "WuSiyingAssignment4"
author: "Wu Siying"
date: "30 November 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(magrittr)
library(dplyr)
library(lubridate)
library(ggplot2)
library(gridExtra)
bank <- read.csv("https://goo.gl/PBQnBt", sep=";")
knitr::opts_chunk$set(echo = TRUE, fig.align = "center", out.width = "100%", dpi = 300, collapse = TRUE, cache = TRUE)
```

#1.

```{r Q1}
center <- ggplot() + #creates the main plot (at bottom left)
  geom_point(data = bank, mapping = aes(x = job, y = balance, color = education), alpha = 0.3) + 
  
  geom_point(data = (group_by(bank, job) %>% summarise(meanBalance = mean(balance))), 
             mapping = aes(x = job, y = meanBalance), color = "blue", shape = "triangle", alpha = 0.2, size = 6)+
  
  geom_line(data = (group_by(bank, job) %>% summarise(meanBalance = mean(balance))), 
            mapping = aes(x = job, y = meanBalance, group = 1), color = "blue") + #connecting the previous geom_point
  
  ylim(-5000,30000) + #scale the axis to exclude the extreme points
  scale_x_discrete(limit = rev(levels(bank$job))) + coord_flip() + 
  theme(legend.position = "bottom") +
  theme(axis.title.x=element_blank())

corner <- ggplot(bank) + geom_point(aes(1,1),colour="white") + #an empty graph at top right corner 
  theme(axis.ticks=element_blank(),
        panel.background=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank())

RHS <- ggplot(bank, aes(x = job, fill = education)) + 
  geom_bar(show.legend = FALSE) + 
  scale_x_discrete(limit = rev(levels(bank$job))) +
  coord_flip() + 
  theme(axis.text.y=element_blank(), axis.title.y=element_blank()) +
  ylab("count\n\n")
  #suppress the display of the  y axis labels (the jobs), which is the same as the main plot
  #theme(legend.position = "bottom")

Top <- ggplot(bank, aes(x = balance)) + geom_density() + xlim(-5000,30000)

grid.arrange(Top, corner, center, RHS, nrow = 2, ncol = 2, heights = c(2,7), widths = c(7,2))
```
The plot on the top shows the distribution of the balance. 
It could be observed that the majority is cluttered around (-2000, 5000) and there are very few people with large positive or negative balance.

The main plots shows the balance of each individual categorised by job, colored by education. It is noted that entrepreneurs, self-employed and managements have higher percentage of having tertiary education than other jobs. This is perhaps because education backgrounds are important as one progress in a corporate setting (for management), and tertiary education equips one with relevant knowledge of how to do business successfully (for entreupreneurs). Another reason could be that after receiving tertiary education those who cannot find a satisfying job tend to start their own business.

The bottom right plot shows the number of people in each job. (its y axis is the same as the main plot so it is not displayed)

#2. composition of education in each job

```{r Q2}
ggplot(bank)+
geom_bar(aes(x= job, fill = education)) + #counts the number of people in each job composed of different education backgrounds
  geom_line(inherit.aes = FALSE, data = (group_by(bank, job, education) %>% summarise(meanBalance = mean(balance))), 
            mapping = aes(x = job, y = meanBalance/4, group = education, color = education), size =1) +
  scale_color_brewer(palette="Dark2") +
  scale_y_continuous(sec.axis =  sec_axis(~.*4, name = "Average Balance"))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

This plot plots the composition of each job category as well as the average balance of each job (on the second axis) grouped by different education backgrounds. 

It could be observed that certain educational backgrounds are more frequent in some jobs, for example, management tends to have tertiary educations. Surprisingly, it is not those with highest educational backgrounds who have the most balance in their accounts. This could be due to 
1. Different spending habbits (those with high educational background could be inclined to spend more)
2. One's wealth/salary (if we use balance as a proxy for wealth and salary) may be determined by factors other than education - one's ability, skills and experience may play equally or more important roles
3. different age composition, which is not shown in the graph. People accumulate more wealth when they are older.

#3.

```{r Q3}
Q3 <- group_by(bank, job, education) %>% 
  summarise(`Default Rate` = sum(default == 'yes')/n())

Q3.1 <- dplyr::filter(bank, default == 'yes') %>%
  group_by(job, education) %>% mutate(meanAge = mean(age)) %>% 
  # calculates the mean age of default individuals for each job & education combination
  group_by(job, education, marital) %>% 
  summarise(countMarital = n(), meanAge = mean(meanAge)) %>% group_by(job,education)%>%
  # counts the cases of different marital status for each job&education combination. The meanAge from the previous step will be preserved.
  dplyr::filter(countMarital == max(countMarital)) %>%
  #filter out the most frequent marital status (the  mode) for each job&education combination
  mutate(maritalCodified = (ifelse(marital == "single", yes = 100, no = ifelse(marital == "married", yes = 10, 1)))) %>%
  #for some job&education groups, two martial status are equally frequent. Codify the marital status to combine them
  group_by(job, education) %>% 
  summarise(`Marital Status Codified` = sum(maritalCodified), meanAge = mean(meanAge)) %>%
  #merge the marital status according to job and education, and preserve meanAge
  mutate(`Marital Status` = case_when(`Marital Status Codified` ==100 ~ "single", 
                                      `Marital Status Codified` ==10 ~ "married", 
                                      `Marital Status Codified` ==1~ "divorced", 
                                      `Marital Status Codified` ==110 ~ "single/married", 
                                      `Marital Status Codified` ==101 ~ "single/divorced", 
                                      `Marital Status Codified` ==11 ~ "married/divorced"))
  #change back the marital status

Q3.2 <- left_join(Q3, Q3.1,by = c("education", "job"))%>%
  dplyr::filter(`Default Rate` > 0)
ggplot(Q3.2) + 
  geom_point(aes(x = job, y = education, size = `Default Rate`, color = `Marital Status`)) +
  geom_text(aes(x = job, y = education, label = round(meanAge,0)), position = position_dodge(width = 0.8), alpha = 0.8) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

This graph plots the profile of those who have defaulted, categorised by education and job. The size of the point represents default rate, color represents the marital status that appeared for the most number of times in that group (the mode). The text represents the mean age of the default individuals in that group.

The default rate is highest among the entrepreneurs across all job categories, possibly because they need capital and their business involves high risks. Default likelihood is highest among people with secondary education across all educational background. The highest default rate appears in the category of housemaids with unknown education. And Tertiary students are also likely to default, possibly because they are too optimistic about their repayment ability at a young age.

#4.

```{r Q4}
Q4 <- dplyr::filter(bank, housing == 'yes'| loan == 'yes') %>% 
  mutate(TypeOfLoan = ifelse(housing == 'yes' & loan =='yes', "Both", ifelse(housing == 'yes', yes = "housing", no = "personal"))) %>%
  group_by(marital,TypeOfLoan) %>%
  summarise(n = n()) %>% group_by(marital)%>%
  mutate(percentage = n/sum(n))

ggplot(data = Q4, aes(x = "", y = percentage, fill = TypeOfLoan)) + geom_bar(position = "fill", stat = "identity") + coord_polar(theta = 'y') + 
  geom_text(aes(label = paste0(round(percentage*100), "%")), 
            position = position_stack(vjust = 0.5)) +
  facet_wrap(~marital, nrow = 1)
```

This plot reports the different composition of loans (among those who take loans) for each marital status.

Among those who take loans, it could be observed that the marital status has moderate impact on the composition of loans. Those who are single seems to be less likely to take up personal loans (the percentage of personal loans taken among all loans is "Both" + "personal"). The percentage of individuals who takes up both loans is highest for married individuals, possibly because the burden of the housing loan could be shared among the couple. While for those who are single, since they do not have anyone to share the financial burden, they could be less likely to take up a personal loan if they already have a housing loan.

#5.

```{r Q5}
Occurences <- count(bank, previous, age) %>% mutate(ageGroup = case_when(age<=40 ~ "young", 
                                                                         (40 < age & age <= 60) ~"middle aged", 
                                                                         60 <age ~ "senior"))
ggplot() + 
  geom_boxplot(data = bank, aes(x = previous, y = balance, group = previous))+
  geom_bar(data = Occurences, aes(x = previous, y = n*20, fill = ageGroup), stat = "identity",  alpha = 0.3)+
scale_y_continuous(sec.axis =  sec_axis(~./20, name = "count"))
```

This plot presents the balance boxplot for different number of previous contacts to explore whether the bank would contact those with higher balance more. It also plots the composition of different age groups for each different value of "previous". 

The result does not seem to suggest that those with highest balance are contacted more often in the past. Among those who have never been contacted previously, there are quite a few outliers with high balance. Perhaps the bank was not making good use of the dataset in identifying potential clients and allocate its resources wisely in the previous campaign. Or the bank could have developed many new clients after the previous campaign has ended.

#6

```{r Q6}
Q6 <- dplyr::filter(bank, poutcome == 'success') %>% 
  mutate(ageGroup = case_when(age<=40 ~ "young", (40 < age & age <= 60) ~"middle aged", 60 <age ~ "senior"))

Q6.1 <- dplyr::filter(bank, previous>0) %>% group_by(job)%>% summarise(successRate = sum(poutcome=="success")/n())

quantiles <- quantile(Q6$previous, seq(0, 1, length = 6))
Q6$prevGroup <- NA
Q6$prevGroup <- cut(Q6$previous, unique(c(0,quantiles)))

ggplot(Q6) + 
  geom_point(aes(x = job, y = balance, size = factor(ageGroup, levels = c("young", "middle aged", "senior"), ordered = TRUE),  color = prevGroup), alpha = 0.4, position = position_dodge(width = 0.5))+
  geom_line(data= Q6.1, aes(x = job, y = successRate * 50000, group = 1)) + 
  scale_y_continuous(sec.axis =  sec_axis(~./50000, name = "SuccessRate")) + 
  labs(size = "age group") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
#position_dodge to avoid overlap
```

This graph explores the profiles of individuals with poutcome = "success". The graph plots the balance of each individual with poutcome success against job, with size representing age group and color representing the levels of previous contacts. The success rate for each job category is plotted on the second axis. 
There are a few groups that seems more likely to purchase the products promoted, such as retired individuals, possibly due to their risk preference, pension fund availability and their need for investment/banking products. Entrepreneurs and self-employed individuals are less likely to purchase the products, which could be possibly because they are sufficiently financially literate themselves and would like to invest on their own. Another possible reason could be that they do not wish to lock up their cash. Students are less likely to purchase the product, possibly because they do not have too much disposable income.

#7.

```{r Q7}
Q7 <- group_by(bank, job, default) %>% summarise(meanDur = mean(duration), meanPrev = mean(previous), meanCamp = mean(campaign))
ggplot(Q7) + geom_point(aes(x = job, y = meanCamp, size = meanDur, alpha = meanDur)) + 
  geom_line(aes(x = job, y = meanCamp, group = 1), linetype = "dotdash") + 
  geom_line(aes(x = job, y = meanPrev, group = 1), color = "blue") +
  facet_wrap(~default, nrow = 2) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ylab("number of contacts")
```

This graph plots the average number of contacts in previous and current campaign (meanPrev and meanCamp) as well as mean duration against job categories for different default history. The dotted line represents number of current campaign contacts. The size and alpha of the point represents the mean duration of the previous contact.

The average number of contacts for current campaign for both groups are higher than that in the previous, possibly because the bank puts more effort in marketing. Generally, those without default are contacted more often, and the duration is more consistent across different job categories for the group without default.

#8. 

```{r Q8}
#Q8 <- mutate(bank, Loans = (housing == 'yes'| loan == 'yes'))
ggplot(bank) + geom_point(aes(x = campaign, y = duration), position = position_dodge(width = 0.5), alpha = 0.2, size = 0.5) + 
  facet_grid(default ~ job) + xlim(0,30)
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

This graph plots the distribution of durations against campaign (number of contacts in the current marketing campaign) for different jobs and history of default. The alpha is adjusted so that the graph also shows the region where the points are more cluttered.

It could be observed that while there is very few observations in the category of default, the number of contacts and mean duration is smaller than the group without default (except for an outlier in the job category housemaid). This could be because those who have defaulted may not have the ability or interest to purchase the product, and the bank may be less willing to contact them too many times for promotion.

#9.

```{r Q9}
Q9 <- mutate(bank, ageGroup = case_when(age<=40 ~ "young", 
                                  (40 < age & age <= 60) ~"middle aged", 
                                  60 < age ~ "senior"))

quantiles9 <- quantile(Q9$balance, seq(0, 1, length = 11))
Q9$Bal <- NA
Q9$Bal <- cut(Q9$balance, quantiles9, include.lowest = TRUE, dig.lab = 10) #cut the balance into different levels and format the intervals

ggplot(Q9 %>% group_by(y, ageGroup, Bal) %>% summarise(n = n(), meanDur = mean(duration))) + 
  geom_line(aes(x = Bal, y = meanDur, group = 1), color = "blue") + 
  geom_bar(aes(x = Bal, y = n*2), stat= "identity", alpha = 0.6) + facet_wrap(ageGroup~y, ncol = 2) +
  scale_y_continuous(sec.axis =  sec_axis(~./2, name = "Count")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

This plot categorize individuals into 10 groups according to their balance and reported the mean duration (line graph with label on the main y axis) and count (bar chart with label on second y axis) in each balance group for different combinations of age groups and term deposit subsriptions. 

It seems that most of the individuals do not have a term deposit. It also seems that those with term deposit are more willing to talk to the salesperson/bank staff for longer duration. It is possible that those with term deposit are more active in managing their wealth and thus they are more willing to know about the products.

#10.

```{r Q10}
Q10 <- group_by(bank, education) %>% summarise(bal = mean(balance), meanDur = mean(duration))

ggplot(data = Q10, mapping = aes(x = reorder(education, bal, FUN = sort), y = bal)) + 
  geom_bar(aes(fill = meanDur), stat = "identity") + 
  scale_fill_continuous(name = "Mean Duration", high = "#132B43", low = "#56B1F7") + #apply a darker fill to higher values
  coord_polar("y") + 
  geom_text(aes(label = round(meanDur,0)), color = "white", position = position_stack(vjust = 0.6)) +
  geom_text(aes(label = round(bal,0)), color = "brown", position = position_stack(vjust = 0.15))+
  xlab("Education")+ylab("Mean Balancce")
  
```

This plot displays the average balance for each educational background (sorted by mean balance). The mean balance for each category is displayed in brown color text. The gradient fill of each bar represents the mean duration, which is labeled using white color text. (The plot is not optimal for conveying the information but I included it because it is interesting to look at.)

It could be observed that individuals with tertiary education backgrounds have the highest average balance and the lowest mean duration (excluding those with unknown educational backgrounds since no information is available). The possible reason could be that individuals with tertiary education backgrounds tend to have their own judgement.Thus they are less willing to listen to or be persuaded by the marketing campaign. Those with lower balance tend to speak for a longer duration, possibly because they want to explore more opportunities to grow their wealth.