---
title: "Assignment 3"
author: "Cq"
date: "2018/11/24"
output: html_document
---
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(tidyverse)
library(dplyr)

bank<-read.csv("http://goo.gl/PBQnBt",sep=";")
```

### Part1: Evaluate a portfolio of options for its total value

We generate 100 options in a portfolio randomly, use the function`GBSOption`to calculate the value of each option and sum them up to get the total value of this portfolio.

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(fOptions)
df<-data.frame(type=sample(c("c","p"),100,replace = TRUE),
               strike=round(runif(100)*100,0),
               underlying=round(runif(100)*100,0),
               Time=1,
               r=0.01,
               b=0,
               sigma=0.3)
d2<-GBSOption(TypeFlag = df$type,S=df$underlying,X=df$strike,Time = df$Time,r=df$r,b=df$b,sigma = df$sigma)@price
cat("The total value is",sum(d2))
```



### Part2: Exploratory data work on the bank dataset.

#### Section1: Basic description of clients 

**Finding 1**

We first analyze the clients with respect to age. Spliting the data into several age group can help us to analyze the data more easily.

From the table below, it is easy to notice that with age increasing, the mean of balance is increasing and the default rate and loan rate is descresing. Also, over 50% of middle age people are under stress from housing loan. Even in senior group, which contain people that are older than 60 years old, around 14% of them still do not get rid off the housing loan.


```{r echo=FALSE}
bank<-mutate(bank,age_group=case_when(
    age<30~"30s",
    age<40~"40s",
    age<50~"50s",
    age<60~"60s",
    TRUE~"senior"))
find1<-group_by(bank,age_group)%>%
  summarise(number=n(),
            mean_age=mean(age),
            default_rate=sum(ifelse(default=="yes",1,0)/n()),
            mean_balance=mean(balance),
            with_housing_rate=sum(ifelse(housing=="yes",1,0)/n()),
            with_loan_rate=sum(ifelse(default=="yes",1,0)/n())
            )
knitr::kable(find1)

```


**Finding 2**

We then analyze the clients with respect to job.

From the table below, we can conclude several point.

* Among all jobs, entrepreneur, unemployed and self employed have the top largest default rate and loan rate.

* Among all jobs, blue-collar, services and admin. have the top housing loan rate.

* Retired people, housemaid and people whose job is management have average higher balance. 

* It is interesting to find that even students may have more balance than blue-collar. I guess phd students may have distracted this result since most of them can get subsidy from government.

```{r echo=FALSE}
find2<-group_by(bank,job)%>%
  summarise(number=n(),
            mean_age=mean(age),
            default_rate=sum(ifelse(default=="yes",1,0)/n()),
            mean_balance=mean(balance),
            with_housing_rate=sum(ifelse(housing=="yes",1,0)/n()),
            with_loan_rate=sum(ifelse(default=="yes",1,0)/n())
            )%>%
  arrange(desc(default_rate))
knitr::kable(find2)
```


#### Section2: Marketing analysis

**Finding 3**

Comparing this campaign outcome to the previous one, we can noticed that more than 60% of people who successfully joined the previous campaign tend to continously join the current one to subscribed a term deposit.

```{r echo=FALSE}
find3<-group_by(bank,poutcome)%>%
  summarise(y_yes=sum(ifelse(y=="yes",1,0)),
            y_yes_rate=y_yes/n(),
            y_no=sum(ifelse(y=="no",1,0)),
            y_no_rate=y_no/n(),
            total=n())
temp<-data_frame(y_yes=sum(ifelse(bank$y=="yes",1,0)),
            y_no=sum(ifelse(bank$y=="no",1,0)),
            y_yes_rate=y_yes/(y_yes+y_no),
            y_no_rate=y_no/(y_yes+y_no))
find3<-full_join(find3,temp,by = c("y_yes", "y_yes_rate", "y_no", "y_no_rate"))
knitr::kable(find3)
```

**Finding 4**

From the table below, we can know that the mean of last contact duration is longer in the group of people who has subscribed a term deposit in this campaign. And for these clients, there were more numbers of contacts performed before this campaign. These may suggested that sellmen should keep in contact with the clients and try to have a conversation with high quality and last for a longer period of time.

```{r echo=FALSE}
find4<-group_by(bank,y)%>%
  summarise(mean_duration=mean(duration),
            mean_campaign=mean(campaign),
            mean_previous=mean(previous))
knitr::kable(find4)
```


**Finding 5**

The result in the table below shows that the ways of contact, telephone or cellular, do not matter much.

```{r echo=FALSE}
find5<-group_by(bank,contact)%>%
  summarise(y_yes=sum(ifelse(y=="yes",1,0)),
            y_yes_rate=y_yes/n())
knitr::kable(find5)
```

**Finding 6**

In the previous finding, we have already noticed that longer duration of contact might contribute to success. We analyze this relationship more specifically in this part.

Grouping the duration into 4 groups according to its quantiles, we can confirm that the success rate is highest in the longest duration group, which last for around 10 minutes at average.

```{r echo=FALSE}
find6<-mutate(bank,duration_group=case_when(
  duration<quantile(duration,0.25)~"1st shortest",
  duration<quantile(duration,0.5)~"2nd shortest",
  duration<quantile(duration,0.75)~"3rd shortest",
  TRUE~"longest"
))%>%
  group_by(duration_group)%>%
  summarise(mean_duration=mean(duration),
            y_yes=sum(ifelse(y=="yes",1,0)),
            y_yes_rate=y_yes/n())%>%
  arrange(desc(y_yes_rate))
knitr::kable(find6)
```


**Finding 7**

We then analyze the relationship between the basic information of clients and the outcome of this marketing campaign.

* The success rate of marketing among senior people is highest.

* Retired people and students seem to be more interested in a term deposit.

* Singles and divorced people are more likely to be persuaded by sellmen and subscribe a term deposit.

* With respect to education, people with teriary eduaction have a higher rate of successful subscrition.

```{r echo=FALSE}
find6<-group_by(bank,age_group)%>%
  summarise(y_yes=sum(ifelse(y=="yes",1,0)),
            y_yes_rate=y_yes/n())%>%
  arrange(desc(y_yes_rate))
knitr::kable(find6)

find6<-group_by(bank,job)%>%
  summarise(y_yes=sum(ifelse(y=="yes",1,0)),
            y_yes_rate=y_yes/n())%>%
  arrange(desc(y_yes_rate))
knitr::kable(find6)

find6<-group_by(bank,marital)%>%
  summarise(y_yes=sum(ifelse(y=="yes",1,0)),
            y_yes_rate=y_yes/n())%>%
  arrange(desc(y_yes_rate))
knitr::kable(find6)

find6<-group_by(bank,education)%>%
  summarise(y_yes=sum(ifelse(y=="yes",1,0)),
            y_yes_rate=y_yes/n())%>%
  arrange(desc(y_yes_rate))
knitr::kable(find6)

```


**Finding 8**

We then analyze the relationship between the outcome of this marketing campaign and the financial status of clients.

From the table below, we can notice that people with more average yearly balance tend to be more interested in a term deposit. Also, the default rate and loan rate among success group and failure group do not vary distinctly. But it is still valueable to know that people suffer from housing loan might not be as interested in term deposit as expected. This may due to those people have more requirement for liquidity.

```{r echo=FALSE}
find7<-group_by(bank,y)%>%
  summarise(mean_balance=mean(balance),
            default_rate=sum(ifelse(default=="yes",1,0)/n()),
            mean_balance=mean(balance),
            with_housing_rate=sum(ifelse(housing=="yes",1,0)/n()),
            with_loan_rate=sum(ifelse(default=="yes",1,0)/n()))
knitr::kable(find7)
```


#### Section3: Other finding about martial status


**Finding 9**

It can frequently be heard in news that the divorce rate is increaing heavily recent years. We here study the relationships between martial status and age, job, education level.

* The divorce rate are over 15% among people who are older than 50 years old. This is quite high according to the records from Nations Demographic Yearbook.

* It should be noticed that retired people and unemployed people have higher divorce rate. The reason for this situation might be that people who are busy with their job have little time to struggle with marital affairs.

* With high level of education, people seem to be more comfortable with single status, which is consistent with common sense.


```{r echo=FALSE}
find9<-group_by(bank,age_group)%>%
  summarise(single_rate=sum(ifelse(marital=="single",1,0)/n()),
            married_rate=sum(ifelse(marital=="married",1,0)/n()),
            divorced_rate=sum(ifelse(marital=="divorced",1,0)/n()))
knitr::kable(find9)

find9<-group_by(bank,job)%>%
  summarise(single_rate=sum(ifelse(marital=="single",1,0)/n()),
            married_rate=sum(ifelse(marital=="married",1,0)/n()),
            divorced_rate=sum(ifelse(marital=="divorced",1,0)/n()))%>%
  arrange(desc(divorced_rate))
knitr::kable(find9)

find9<-group_by(bank,education)%>%
  summarise(single_rate=sum(ifelse(marital=="single",1,0)/n()),
            married_rate=sum(ifelse(marital=="married",1,0)/n()),
            divorced_rate=sum(ifelse(marital=="divorced",1,0)/n()))%>%
  arrange(desc(single_rate))
knitr::kable(find9)
```


**Finding 10**

There is a saying that staying single helps to saving money. This is conflict with our finding.

Aftering removing the group of students, who are mostly single and purchase little, we get the result below. It is interesting to find that the average of balance between married people and single do not have a great difference. Also, staying in a marital status might push people to become more aware of their credit, which can be revealed by the low default rate and loan rate.

```{r echo=FALSE}
find10<-dplyr::filter(bank,job!="student")%>%
  group_by(marital)%>%
  summarise(mean_balance=mean(balance),
            default_rate=sum(ifelse(default=="yes",1,0)/n()),
            with_housing_rate=sum(ifelse(housing=="yes",1,0)/n()),
            with_loan_rate=sum(ifelse(default=="yes",1,0)/n()))
knitr::kable(find10)
```

*All plots will be included in the next assignment.*

### Part3: Book option trades

#### 1
  
  I use the stock price, 1023.88, of GOOG at 2018-11-23 as current price.
  
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(tidyverse)
library(fOptions)

goog <- read_csv("GOOG.csv")
underlying=1023.88
goog<-mutate(goog,`Expiry Date`='2018-12-14')
df1<-select(goog,`Expiry Date`,9,7,8,1,4,5)%>%
  rename(`Open Interest`='Open Int',Underlying=Root,`Call/Put`=Calls)%>%
  mutate(`Call/Put`="c",Underlying=underlying)
df2<-select(goog,`Expiry Date`,9,16,8,10,13,14)%>%
  rename(`Open Interest`=3,Underlying=4,`Call/Put`=5,Bid=6,Ask=7)%>%
  mutate(`Call/Put`="p",Underlying=underlying)
goog<-full_join(df1,df2)
knitr::kable(goog)
```
  
#### 2 count the total valuation

* The total valuation of call option and put option respectively:

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
q1<-group_by(goog,`Call/Put`)%>%
summarise(total=sum(`Open Interest`*(Bid+Ask)/2))
knitr::kable(q1)
```


* The total valuation of call option and put option totally:
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
cat("The total valuation is",sum(goog$`Open Interest`*(goog$Bid+goog$Ask)/2))
```



#### 3 Find those in/out the money and get their total Open Interest.

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
q3<-mutate(goog,`In/Out`=ifelse(`Call/Put`=="c",
                         ifelse(Strike<Underlying,"In","Out"),
                         ifelse(Strike>Underlying,"In","Out")))%>%
  group_by(`In/Out`)%>%
  summarise(`total open interest`=sum(`Open Interest`))
knitr::kable(q3)
```



#### 4 Volatility curve

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
t<-as.numeric((as.Date("2018-12-14")-as.Date("2018-11-23")))/365
goog<-mutate(goog,price=(Bid+Ask)/2)
q4<-dplyr::filter(goog,
                 (`Call/Put`=="p"&Strike<Underlying)|
                 (`Call/Put`=="c"&Strike>Underlying))%>%
  mutate(Volatility=Vectorize(GBSVolatility)
        (price,`Call/Put`,Underlying,Strike,t,r=0.03,b=0))
plot(q4$Strike,q4$Volatility)
```





