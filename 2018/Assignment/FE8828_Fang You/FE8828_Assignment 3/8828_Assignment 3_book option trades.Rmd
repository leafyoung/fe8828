---
title: "FE8828_Assignment 3_book option trades"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(DT)
library(readxl)
```

## Book Option trades

As of 18 Nov 2018 01:29hrs, stock price of GOOG is $1061.66.
raw data is stored in an excel file named as "Book option trades_raw data.xlsx"

#1.1 Gather data for "Dec 14, 2018" and store into following data frame format

| Expiry date | Strike | Open Interest | Underlying | Call/Put | Bid | Ask

```{r, echo = TRUE}

df <- read_excel("Book option trades_raw data.xlsx") %>%
  filter(., Calls == "Dec 14, 2018") %>% #remove dates that are not 14 Dec 2018
  select(-Chg,-Vol,-Root) #remove unwanted columns

df_call <- select(df,c(Calls,Strike,"open Int",Bid,Ask)) %>%
  mutate("Call/Put" = "Call") %>%
  mutate("Underlying" = 1061.66) %>%
  rename("Expiry Date" = "Calls") %>%
  rename("Open Interest" = "open Int") %>%
  select(c("Expiry Date","Strike","Open Interest","Underlying","Call/Put","Bid","Ask"))

df_put <- select(df,c(Puts,Strike,"Open Int",Bid__1,Ask__1)) %>%
  mutate("Call/Put" = "Put") %>%
  mutate("Underlying" = 1061.66) %>%
  rename("Expiry Date" = "Puts") %>%
  rename("Open Interest" = "Open Int") %>%
  rename("Bid" = "Bid__1") %>%
  rename("Ask" = "Ask__1") %>%
  select(c("Expiry Date","Strike","Open Interest","Underlying","Call/Put","Bid","Ask"))

df2 <- bind_rows(df_call,df_put)
datatable(df2)
  
```

##1.2 Count the total valuation of 1) Call alone, 2) put alone, 3) call and put.

Where valuation = Open interest  * (Bid + Ask)/2

```{r, echo=TRUE}

#rename column names with special characters
df2a <- rename(df2, "Call_Put" = "Call/Put") %>%
  rename("Open_Interest" = "Open Interest")

val <- group_by(df2a, Call_Put) %>%
  summarize(., 
            valuation = sum(ifelse(Call_Put == "Call",(Open_Interest * (Bid + Ask)/2),(Open_Interest * (Bid + Ask)/2))),
  ) %>%
  ungroup

val <- bind_rows(val,list(Call_Put = "Call_and_Put",valuation = sum(val$valuation))) %>%
  rename("Call/Put" = "Call_Put")
datatable(val) %>% formatCurrency(.,columns = "valuation", currency = "$",interval = 3)            
```

##1.3 Find those in the money and get their total open interest

In the money means Call options with underlying > strike price and put options with underlying < strike price

``` {r, echo=TRUE}

df3 <- mutate(df2a, Moneyness = ifelse((Call_Put == "Call" & Underlying > Strike) | (Call_Put == "Put" & Underlying < Strike), "In the money",
                                 ifelse(Underlying == Strike,"At the money","Out of the money"))
)

df3a <- group_by(df3,Moneyness,Call_Put) %>%
  summarize(., 
            open_int = sum(ifelse(Moneyness == "In the money" & Call_Put == "Call",Open_Interest,
                           ifelse(Moneyness == "In the money" & Call_Put == "Put",Open_Interest, Open_Interest))),
            )

datatable(df3a)
```

#1.4 Plot the volatility curve

Use GBSVolatility function to calculate implied volatility based on price = (Bid+Ask)/2

```{r, echo = TRUE}

library(fOptions)
time = as.numeric((as.Date("2018-12-14") -as.Date("2018-11-14"))/365) #time to maturity in years

df4 <- group_by(df3,Call_Put,Underlying,Strike) %>%
  mutate(.,ttm = as.numeric((as.Date("2018-12-14") -as.Date("2018-11-14"))/365)) %>%
              mutate(., implied_vol = GBSVolatility(                          price = (Bid+Ask)/2,
                        TypeFlag = ifelse("Call_Put" == "Call","c","p"),
                        S = 1061.66,
                        X = Strike,
                        Time = ttm,
                        r = 0.03, #arbitrary r at 3%
                        b = 0.1, #arbitrary cost of carry rate = 10%
                            )
              )

ggplot(df4,aes(x=Strike,y=implied_vol)) +
  geom_smooth(color = "red") +
  labs(subtitle = "Volatility curve")

```

