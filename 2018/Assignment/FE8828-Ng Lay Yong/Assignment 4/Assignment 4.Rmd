---
title: "Assignment 4"
author: "Ng Lay Yong"
date: "November 29, 2018"
output: html_document
---

```{r library, echo=FALSE, message = FALSE, warning=FALSE}
library(fOptions)
library(tidyverse)
library(bizdays)
library(knitr)
library(ggplot2)
library(tibble)
library(gridExtra)
bank<-read.csv("http://goo.gl/PBQnBt",sep=";")
```

## Insight 1
Students generally form a distribution below age 30 and retirees are distributed age 50 and above. We can also see some density above age 70 for those working in the management.
```{r}
ggplot(bank, aes(age,color=job,fill=job,alpha=0.2))+geom_density()

```

##Insight 2
When grouped by education, those with tertiary education seem to retire later. And as expected, those age 15 and below have primary education only. There is also a rather higher density of blue-collar workers, age 30 to 40, with tertiary education. The density of blue-collar workers with tertiary education from this age group (30-40) is also higher than that for primary and secondary education. This is rather surprising as one would expect blue-collar workers to possess lower education.
```{r}
bank%>%dplyr::filter(education!="unknown")%>%ggplot(aes(age,color=job,fill=job,alpha=0.2))+geom_density()+facet_wrap(~education, nrow=1)

```

## Insight 3
We can see that none of those above age 70 have unknown contact. Perhaps the elderly are more willing to share their contact information.

```{r}
ggplot(bank)+geom_point(aes(age,duration,color=contact))
```

##Insight 4
The graph below shows the percentage of success for each age group. This shows that the bank may want to consider calling customers of age 60 and above to have a higher chance of successful calls.

```{r}
bank %>% group_by(age_group = (age %/% 10)*10) %>%
  summarise(count_age =n())%>%dplyr::filter(age_group!="10")%>%
  arrange(age_group)-> count_age
filtersuccess<-group_by(bank,age_group = (age %/% 10)*10,poutcome)%>%summarise(count=n())%>%dplyr::filter(poutcome=="success")
combine<-left_join(count_age,filtersuccess,by="age_group")%>%mutate(percent=count/count_age*100)
combine %>%
  ggplot(aes(x=age_group,y = percent))+
  geom_point(aes(size = count_age), alpha =1/4, color="blue")+
  geom_smooth(se=FALSE, method="loess", color = "pink")+
  xlab("Age Group")+
  ylab("Percentage of Success")

```

##Insight 5
The distribution of the unemployed look similar for those with secondary and tertiary education. Age below 40 form more than half of the distribution. However, the reverse is true for the unemployed with primary education. Age above 40 form the bulk of the distribution for those who have primary education and are unemployed.
This is probably because those who have lower education levels, tend to work in areas which require hard labour and are therefore unable to find employment as they grow older.
```{r}
bank%>%dplyr::filter(job=="unemployed")%>%dplyr::filter(education!="unknown")%>%ggplot(aes(age,color=job,fill=job,alpha=0.9))+geom_density()+facet_wrap(~education, nrow=1)
```

##Insight 6
For clients without loans and above the age of 45, it is evident that the call duration increases with age. Retirees also seem to have longer call duration than all other job categories. It is likely that they are idling at home and do not mind taking cold calls.

```{r}
cutpoints<- quantile(bank$age,seq(0,1,length= 4),na.rm= TRUE)
bank$age_group<- cut(bank$age,cutpoints)
ggplot(bank,aes(age,duration))+
geom_point(aes(color=job,alpha= 1/3))+
facet_wrap(loan~ age_group,nrow= 2)+
geom_smooth(method="lm",se=FALSE,col="green")+
theme_minimal(base_size= 12)+
labs(x= "age",y= expression("log" * Duration))+
scale_y_log10()+
labs(title= "Duration vs Age, with and without loans")
```

##Insight 7
It is rather alarming that clients age above 60 tend to have no housing. Most of this group of clients also have low account balances. More clients age between 20 to 50 have housing and their account balances are also higher than those at the tail end of the distribution.
```{r}
df<- bank
hist_top<- ggplot(df,aes(x=age))+ geom_density()
empty<-
ggplot()+geom_point(aes(1,1),colour="white")+
theme(axis.ticks=element_blank(),
panel.background=element_blank(),
axis.text.x=element_blank(),axis.text.y=element_blank(),
axis.title.x=element_blank(),axis.title.y=element_blank())

scatter<- ggplot(df,aes(x=age,y=balance))+ geom_point(aes(color=housing,alpha= 1/3))

hist_right<- ggplot(df,aes(x=balance))+ geom_density()+ coord_flip()
grid.arrange(hist_top,empty,scatter,hist_right,
ncol=2,nrow=2,
widths=c(3.5,0.7),heights=c(1,4))
```

##Insight 8
Most of the clients with primary education are blue-collar workers. This gels with the theory in insight 5 that those with lower education levels, tend to work in areas which require hard labour and are therefore unable to find employment as they grow older.

Most of the clients working in management possess tertiary education and the second largest group of tertiary educated clients work as technicians. This is not surprising since managers and technicians fall under the PMET (professionals, managers, engineers and technicians) group which normally require higher levels of qualifications.

The top 3 clients with longest mean call duration are the retirees, housemaids and unemployed which makes sense since these groups of clients have more free time to take calls.

```{r}
ggplot(bank,aes(x= reorder(job,duration,FUN=mean),
fill=education))+
geom_bar()+
scale_x_discrete(limit=
rev(levels(reorder(bank$job,bank$duration,FUN=mean))))+
geom_line(aes(x=job,y=duration))+
geom_point(data= group_by(bank,job)%>%
summarize(duration= mean(duration))%>% ungroup,
aes(x=job,y=duration),inherit.aes= FALSE)+
xlab("Job sorted by\nmean duration\n(Short duration on top)")+
ylab("Count/Duration")+
coord_flip()
```

##Insight 9
The pecentage of loans within each job category is shown below. We can see that entrepreneurs have the highest percentage of loans. This is understandable since entrepreneurs are likely to take up loans to support their business ventures. Very low percentages of those with unknown jobs have taken up loans, possibily because the number of observations for the unknowns are much smaller than other job categories and in the small sample of unknowns, very few of them have loans. Students have the lowest percentage of loans since most of them would be ineligible to take up loans.

```{r}
jobno<-group_by(bank,job)%>%summarise(jobno=n())%>%arrange(jobno)
dfjob<-data.frame(jobno)
hist_job<-ggplot(dfjob, aes(job))+geom_density()
loanbyjob<-group_by(bank,job)%>%summarise(jobno=n(),loan_count=sum(ifelse(loan=="no",0,1)),percentloan=loan_count/jobno*100)
ggplot(loanbyjob, aes(reorder(job, percentloan),percentloan)) +
  geom_point(size=5, col=colors()[552], fill=alpha("yellow", 0.3), alpha=0.7, shape=21, stroke=3) + 
  geom_segment( aes(x=job, xend=job, y=0, yend=percentloan), size=2, col=colors()[56])+
  theme(axis.text.x= element_text(angle= 90,hjust= 1))+
  xlab("Jobs") +
  ylab("%Loan in each Job")
```

##Insight 10
There are no singles age above 70. Perhaps singles do not have high life expectancy due to loneliness or elderly singles do not like to do any business with the bank. The highest density of singles are students, which is expected since many of them are still studying and do not have marriage plans yet.

```{r}
g<-ggplot(bank,aes(age,balance))
g+geom_point(aes(age,balance,color=job))+geom_smooth()+facet_grid(~marital)
ggplot(bank, aes(age,color=job,fill=job,alpha=0.2))+geom_density()+facet_grid(~marital)

```

There seems to be a higher number of singles with tertiary education. We may infer that highly educated clients either do not want to get married or do not have time to search for a partner. We can also see a higher density of middle-age clients with primary education who are divorced. This is also true for elderly divorcees. It seems like divorcees with secondary or tertiary education are much younger. Perhaps the more intellectual they are, the more demands they require out of their marriages, leading to divorces becoming more prevalent amoung younger age groups.

```{r}
g+geom_point(aes(x=age,y=balance,color=education))+geom_smooth()+facet_grid(~marital)
ggplot(bank, aes(age,color=education,fill=education,alpha=0.2))+geom_density()+facet_grid(~marital)
```

