---
title: "Assginment3.3"
output: html_document
---

## Google Option Chain Analysis

## 1.1
Copy the options data from https://www.nasdaq.com/symbol/goog/option-chain?dateindex=1
```{r setup, include=FALSE}
library(tidyverse)
library(fOptions)
library(lubridate)
library(bizdays)
library(ggplot2)
# Use echo = TRUE for assignment is an exception, so code is visible. 
knitr::opts_chunk$set(echo = TRUE, fig.align="center", collapse = TRUE, cache = TRUE) 
option <- read.csv("Google_option.csv", sep = ",")
names(option) = c('Expiry Date','Strike','Open Interest','Underlying','Call/Put','Bid','Ask')
option$`Call/Put`<- tolower(option$`Call/Put`)
```

## 1.2
Count the total valuation of 1) call alone, 2) put alone, 3) call and put.
```{r total_valuation, echo=FALSE}
option%>%
  mutate(value = `Open Interest`*(Bid+Ask)/2) -> res
call_valuation <- sum(ifelse(res$`Call/Put` == 'c',res$value,0))
put_valuation <- sum(ifelse(res$`Call/Put` == 'p',res$value,0))
total_valuation <- call_valuation + put_valuation
msg <- paste0( "The total valuation of all call options: ", call_valuation, "; The total valuation of all put options: ", put_valuation, "; The total valuation of all call options: ", call_valuation, "; The total valuation of all call and put options: ", total_valuation)
msg
```

## 1.3
Find those in the money and get their total Open Interest.
```{r in_the_money, echo=FALSE}
option %>%
  dplyr::filter((`Call/Put` == 'c'&Underlying > Strike)|(`Call/Put`=='p'&Underlying < Strike))-> res
total_OI = sum(res$`Open Interest`)
msg <- paste0("The total Open Interest for in the money options is:", total_OI)
msg
res


```

## 1.4
Plot the volatility curve, strike v.s. vol. For strike < current price, use puts' price; for strike > current price, use calls' price.  
Note: The price data is as of Nov 23 2018, hence set it as T0. Assume the annualized interest rate r is 0.03 and the annualize cost-of-carry rate b is 0.
And based on the criteria, we are always using out-of-the-money options.
```{r volatility_curve, echo=FALSE}
time <- as.numeric((as.Date("2018-12-14") - as.Date("2018-11-23"))/365)

option %>%
  dplyr::filter((`Call/Put` == 'c'&Underlying < Strike)|(`Call/Put`=='p'&Underlying > Strike)) %>%
  mutate(price = (Bid+Ask)/2) %>%
  mutate(vol = Vectorize(GBSVolatility)(price,`Call/Put`, S = Underlying, Strike, Time= time, r=0.03, b = 0.00 ,maxiter = 1000)) -> res
ggplot(res, aes(x=Strike, y=vol)) +
  geom_line()+
  labs(x = "Strike Price", y="Volatility")
```