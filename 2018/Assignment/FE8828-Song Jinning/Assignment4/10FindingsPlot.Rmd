---
title: "Assignment4"
author: "Song Jinning"
date: "2018/12/02"
output: html_document
---

```{r setup}
library(ggplot2)
library(tidyverse)
library(tidyr)
library(lubridate)
library(bizdays)
library(grid)
library(dplyr)
library(knitr)
library(DT)
library(xtable)
# Use echo = TRUE for assignment is an exception, so code is visible. knitr::opts_chunk$set(echo = TRUE, fig.align="center", collapse = TRUE, cache = TRUE) 
bank <- read.csv("https://goo.gl/PBQnBt", sep = ";")
```
# Finding #1
This plot shows the number of people at each age group that has and has not defaulted before. None of the clients ablove 60s has defaulted.
It also shows the age distribution of the clients. The age group with largest number of people is 30-40.
```{r}
df_ys <- 
  group_by(bank, round(age/10)) %>% 
             summarise(y=sum(default=="yes"),total=n())%>% 
             mutate (n=total-y)%>%
             rename(age='round(age/10)')%>%
             mutate(age=age*10+5)
ggplot(bank,aes(age,default))+
  geom_point(aes(age,default,color=paste0(round(age/10)*10,"s"))) + 
  geom_text(data=select(df_ys,age,n) %>% filter(n>0), aes(x=age,y=1.2,label =n))+
  geom_text(data=select(df_ys,age,y) %>% filter(y>0), aes(x=age,y=2.2,label =y))
```
# Finding #2
This plot shows job sorted according to median age, together with the range of age and the distribution of the education level among each job.
Most people who do management jobs have tertiary education level, most people who have primary education level are blue-collar workers.
```{r}
ggplot(data = bank, mapping = aes(x = reorder(job, age, FUN = median), fill = education)) +
  geom_bar() +
  scale_x_discrete(limit =
  rev(levels(reorder(bank$job, bank$age, FUN = median)))) + 
  geom_line(aes(x = job, y = age*10)) +
  geom_point(data = group_by(bank, job) %>%
               summarize(age = median(age*10)) %>% ungroup, 
             aes(x = job, y = age), inherit.aes = FALSE) +
  xlab("Job sorted according to\nMedian age\n(Top - younger)") + coord_flip()
```
# Finding #3
This plot shows the age density of people with various occupations. Except those retired, housemaids and unemployed people tend to have the higher age, and most students have lower age. The age distributions of people doing other jobs are roughly the same.
```{r}
ggplot(bank, aes(age, color = job, alpha = 0.3)) + geom_density()
```
# Finding #4

Those who have high balance in their accounts are more likely to be manager, technician or blue-collar worker.
For admin, blue-collar, management and technician, people with higher age tend to have higher balance.
```{r}
ggplot(bank%>%dplyr::filter(balance<20000), aes(age, balance)) + geom_point(aes(color = job)) + geom_smooth() +
facet_wrap( ~ job, nrow=2)
```
# Finding #5
The clients who have defaulted before have significantly lower balance than those who have not defaulted, and some of them have negative balance.

```{r}
ggplot(bank%>%dplyr::filter(balance<20000)) +
geom_point(aes(age, balance, alpha = default))
```

# Finding #6
If the previous marketing campaign is successful, the probability of success for this marketing campaign is a lot higher as compared to other outcomes.
```{r}
ggplot(bank) +
geom_bar(mapping = aes(x = poutcome, fill = y), position = "fill") + coord_polar()
```
# Finding #7
Compared to younger people, older people use telephone more.
```{r}
ggplot(bank) +
geom_bar(mapping = aes(x = age, fill = contact), position = "fill") + coord_flip() +
scale_x_reverse()
```
# Finding #8
The duration of the call for unemployed, retired and blue-collar people are relatively longer, whereas for admin and self-employed people are shorter.
```{r}
ggplot(data = bank, mapping = aes(x = reorder(job, duration, FUN = median), fill = education)) +
  geom_bar() +
  scale_x_discrete(limit =
  rev(levels(reorder(bank$job, bank$duration, FUN = median)))) + 
  geom_line(aes(x = job, y = duration/5)) +
  geom_point(data = group_by(bank, job)%>%summarize(duration = median(duration/5)) %>% ungroup,
             aes(x = job, y = duration), inherit.aes = FALSE) +
  xlab("Job sorted according to\nMedian duration") + coord_flip()
```
# Finding #9
If the previous marketing campaign is successful, the last contact duration is likely to be relatively long. If the previous marketing campaign is failure, the last contact duration is likely to be relatively short, and the variance is relatively small.
```{r}
ggplot(bank, aes(poutcome, duration)) + scale_x_discrete(limit =
  rev(levels(reorder(bank$poutcome, bank$duration, FUN = median))))+geom_boxplot()
```
# Finding #10
Clients with 60+, single or divorced, and without loan are more likely to subscribe for a term deposit.
```{r}
ggplot(data = bank) +
geom_bar(mapping = aes(x = age, fill=y),position = "fill") + facet_wrap(loan ~ marital, nrow = 2)
```