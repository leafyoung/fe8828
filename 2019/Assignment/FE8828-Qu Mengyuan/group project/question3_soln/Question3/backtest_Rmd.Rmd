---
title: "Part 3: Backtest on One-Year Data"
author: "WangPeng, Qu Mengyuan"
date: "2019/10/16"
output: html_document
---

```{r setup, include=FALSE}
library(readxl)
library(tidyverse)
library(fOptions)
library(xts)
knitr::opts_chunk$set(echo = TRUE)
vol<- read_excel("~/Desktop/NTU/PROGRAMMING WEB APPLICATIONS IN FINANCE/FE8828-Qu Mengyuan/group project/VXAZNCLS.xlsx", 
                 col_types = c("date", "numeric"))
close <- read_excel("~/Desktop/NTU/PROGRAMMING WEB APPLICATIONS IN FINANCE/FE8828-Qu Mengyuan/group project/VXAZNCLS.xlsx", 
                    sheet = "Sheet2", col_types = c("date", "numeric"))
```

# 1 Output of Backtest 
```{r}
df <- left_join(close,vol,by = c("Date"="observation_date"))
df <- mutate(df, month = as.numeric(substring(df$Date,6,7)))
max_drawdown <- rep(0,12)
sharpe_ratio <- rep(0,12)
maturity_date <- c()
type <- c("c","c","p","c","c","p","c","c","c","p","p","p")
df1 <- dplyr::filter(df, month == 0)
for(ii in 1:12){
  df_sub <- dplyr::filter(df, month == ii)
  start_date <- min(df_sub$Date)
  end_date <- max(df_sub$Date)
  maturity_date <- c(maturity_date, as.Date(end_date))
  start_price <- df_sub$Close[1]
  df_sub <- mutate(df_sub,volatility = VXAZNCLS/100)
  start_volatility <- df_sub$volatility[1]
  df_sub <- mutate(df_sub,time_to_M = as.numeric(difftime(as.POSIXct(end_date), as.POSIXct(df_sub$Date, tz="UTC"), units="days")/365))
  df_sub <-df_sub%>%mutate(premium = 100 * GBSOption(TypeFlag = type[ii],
                                                 S = df_sub$Close,
                                                 X = start_price,
                                                 Time = time_to_M,
                                                 r = 0.8/100, # interest rate
                                                 b = 0,
                                                 sigma = start_volatility)@price)%>%
    mutate(Option_DoD_PnL = ifelse(df_sub$Date == start_date,
                                   # On the 1st date, we count the cost of buying the option
                                   premium * (-1),
                                   premium - dplyr::lag(premium))) 
  
  
  df_sub <- df_sub %>%
    rowwise() %>%
    mutate(delta_hedge = 100 * GBSGreeks("delta", TypeFlag = type[ii], S=Close, X = start_price , Time = time_to_M, r = 0.8/100, b = 0, sigma = start_volatility )  * (-1)) %>%
    ungroup()%>%
    mutate(Hedging_DoD_Pnl = ifelse(Date == start_date,
                                    0,
                                    dplyr::lag(delta_hedge) * (Close - dplyr::lag(Close))))
  
  df_sub <- df_sub%>%
    mutate(
           daily_PnL = Option_DoD_PnL + Hedging_DoD_Pnl,
           Option_Final_PnL = cumsum(Option_DoD_PnL),
           Hedging_Final_PnL = cumsum(Hedging_DoD_Pnl),
           Final_PnL = Option_Final_PnL + Hedging_Final_PnL,
           max_d = cummax(Final_PnL) - cummin(Final_PnL),
           portfolio_value = Close * delta_hedge + premium,
           return = ifelse(Date == start_date,
                           0,
                           daily_PnL/dplyr::lag(portfolio_value)))
  df1 <- bind_rows(df1,df_sub)
  
  max_drawdown[ii] <- 
    {
      xs <- df_sub$Final_PnL
      max(cummax(xs) - cummin(xs))
    }
  
  sharpe_ratio[ii] <- (mean(df_sub$return[2:length(df_sub$return)])-0.008/250)/stdev(df_sub$return[2:length(df_sub$return)])
  
}
max_drawdown
sharpe_ratio
```

# 2 Analysis
## 2.1 Distribution of Final Pnl
The final profit and loss on Option side is left-skewed, which is centered around -$5000.

The final profit and loss on Hedge side is right-skewed, which is centered around -$2500.

The final profit and loss of Delta Hedge Strategy is left-skewed, which is centered around -5000.
```{r}
res1 <-dplyr::filter(df1, month == 4)
ggplot(res1,aes(Option_Final_PnL))+geom_density()
ggplot(res1,aes(Hedging_Final_PnL))+geom_density()
```

## 2.2 Distribution of Max Drawdown
The max drawdown of Delta Hedge Strategy is controled under $1500.
```{r}
res2 <-dplyr::filter(df1, month == 4) 
ggplot(res2,aes(max_d))+geom_density()
```

## 2.3 Final Pnl vs Time to maturity
As time to maturity extends, final profit on option side decreases while that on Hedge side increases.
```{r}
res3 <-dplyr::filter(df1, month == 4) 
ggplot(res3, aes(time_to_M,Option_Final_PnL ))+geom_point()+geom_smooth()
ggplot(res3, aes(time_to_M,Hedging_Final_PnL ))+geom_point()+geom_smooth()
```

## 2.4 Daily Pnl vs Stock Price
Generally, the higher Stock Close Price is, the higher Daily Profit and loss on Option side is while there is no obvious relationship between stock close price and Daily Profit and loss on Hedge side.
```{r}
res4 <-dplyr::filter(df1, month == 4)
ggplot(res4, aes(Close,Option_DoD_PnL))+geom_point()+geom_smooth()
ggplot(res4, aes(Close,Hedging_DoD_Pnl))+geom_point()+geom_smooth()
```

## 2.5 Sharpe ratio vs Maturity date
There is no direct evidence which indicates a certain relationship between strategy's Sharpe Ratio and time to maturity.
```{r}
plot(maturity_date, sharpe_ratio)
```








