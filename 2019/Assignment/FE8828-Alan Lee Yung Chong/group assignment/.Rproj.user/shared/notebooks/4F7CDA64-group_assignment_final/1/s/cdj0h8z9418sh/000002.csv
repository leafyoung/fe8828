"0","# Track PnL against time to maturity."
"0","df_filtered <- df_pnl %>% select(date, Option_DoD_PnL, Hedging_DoD_Pnl, DoD_PnL)"
"0","colnames(df_filtered)[colnames(df_filtered)==""Option_DoD_PnL""] <- ""Option PnL"" "
"0","colnames(df_filtered)[colnames(df_filtered)==""Hedging_DoD_Pnl""] <- ""Stock PnL"" "
"0","colnames(df_filtered)[colnames(df_filtered)==""DoD_PnL""] <- ""DoD PnL"" "
"0","df_melt <- reshape2::melt(df_filtered, id.var='date')"
"0","colnames(df_melt)[colnames(df_melt)==""variable""] <- ""PnL Types"""
"0","df_melt$M_Y<-format(df_melt$date,""%y/%m"")"
"0","colnames(df_melt)[colnames(df_melt)==""M_Y""] <- ""Year/MM"""
"0","#Calculate the maximum drawdown in each month"
"0","df_DoD_pnL <- df_filtered %>% select(date, `DoD PnL`) "
"0","df_DoD_pnL$M_Y <-format(df_DoD_pnL$date,""%y/%m"")"
"0","# colnames(df_DoD_pnL)[colnames(df_DoD_pnL)==""M_Y""] <- ""Year/MM"""
"0","label_month <- unique(df_DoD_pnL$M_Y)"
"0","# storage for sharpe and max drawdown"
"0","sharpe_bank <- c()"
"0","drawdown_bank <- c()"
"0","final_pnl_bank <- c()"
"0","riskfree = 0.8/100"
"0","pos = 1"
"0","for (i in unique(df_DoD_pnL$M_Y)){"
"0","  df_selected <- df_DoD_pnL %>% dplyr::filter(M_Y == i)"
"0","  #"
"0","  max_drawdown_monthly <- df_selected %>% {"
"0","  xs <- na.omit(.$`DoD PnL`)"
"0","  max(na.omit(cummax(xs) - cummin(xs)))"
"0","  }"
"0","  "
"0","  sharpe_monthly <- df_selected %>% {"
"0","  xs <- na.omit(.$`DoD PnL`)"
"0","  (mean(xs) - riskfree)/sd(xs)"
"0","  }"
"0","  "
"0","  pnl_last_D <- df_selected %>% {"
"0","  xs <- na.omit(.$`DoD PnL`)"
"0","  na.omit(cumsum(xs))[length(xs)]"
"0","  }"
"0","  "
"0","  # print(paste0(""pnl on last day: "", pnl_last_D))"
"0","  # print(paste0(""Sharpe for each month: "", sharpe_monthly))"
"0","  # print(paste0(""Max drawdown for each month: "", max_drawdown_monthly))"
"0","  "
"0","  drawdown_bank[i]<- as.numeric(max_drawdown_monthly)"
"0","  sharpe_bank[i]<- as.numeric(sharpe_monthly)"
"0","  final_pnl_bank[i]<- as.numeric(pnl_last_D)"
"0","  "
"0","  pos<- pos+1"
"0","}"
"0","df_plot = tibble(monthly=unique(df_DoD_pnL$M_Y), monthly_drawdown=drawdown_bank, monthly_sharpe=sharpe_bank, monthly_pnl = final_pnl_bank)"
"0","# plotting the histogram for monthly sharpe and monthly draw down"
"0","p1 <- ggplot(df_plot, aes(y=monthly_sharpe, x=monthly, fill=monthly)) + geom_bar(position=""dodge"", stat=""identity"") + theme(axis.text.x=element_text(angle=45, vjust=.8, hjust=1))+"
"0","  theme(plot.title = element_text(hjust = 0.5))+"
"0","  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = ""black"")) + ggtitle(""Distribution of Monthly Sharpe"")"
"0","p2 <- ggplot(df_plot, aes(y=monthly_drawdown, x=monthly, fill=monthly)) + geom_bar(position=""dodge"", stat=""identity"") + theme(axis.text.x=element_text(angle=45, vjust=.8, hjust=1))+"
"0","  theme(plot.title = element_text(hjust = 0.5))+"
"0","  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = ""black"")) + ggtitle(""Distribution of Monthly Drawdown"")"
"0","p3 <- ggplot(df_plot, aes(y=monthly_pnl, x=monthly, fill=monthly)) + geom_bar(position=""dodge"", stat=""identity"") + theme(axis.text.x=element_text(angle=45, vjust=.8, hjust=1))+"
"0","  theme(plot.title = element_text(hjust = 0.5))+"
"0","  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = ""black"")) + ggtitle(""Distribution of Monthly PnL"")"
"0","p4 <- ggplot(df_plot, aes(x=monthly, y=monthly_pnl, group = 1)) + "
"0","  geom_line() + xlab(""Date"") + ylab(""Final PnL"") + ggtitle(""Final Monthly PnL  vs Time to expiry"")+ theme(plot.title = element_text(hjust = 0.5)) +"
"0","   theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = ""black""))"
"0","p5 <- ggplot(df_DoD_pnL)+ "
"0","  geom_density(aes(`DoD PnL`, fill=M_Y), alpha=0.5) +"
"0","  facet_wrap(~M_Y) +"
"0","  coord_cartesian(xlim=c(-500, 500)) + "
"0","  xlab(""DoD PnL"") + "
"0","  ylab(""Density"") + "
"0","  ggtitle(""Distribution of PnL within the month"") +"
"0","  theme(plot.title = element_text(hjust = 0.5)) +"
"0","  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),"
"0","  panel.background = element_blank(), axis.line = element_line(colour = ""black""))"
"0","grid.arrange(p1, p2, p3, p4, p5, nrow = 5)"
