---
title: "FE8828 Assignment for Bank"
author: "Zhang Yiwen, Liu Zhe, Wu Kaibin, Zheng Chen"
date: "2017/12/16"
output: html_document
---

```{r setup, include=FALSE}
#Initialization in this chart. Loaded nameList for account.
#Create dataframe 1 : account.
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(tidyr)
library(random)
library(stringr)
library(quantmod)
library(bizdays)
library(plyr)
library(knitr)
library(kableExtra)
library(DT)
knitr::opts_chunk$set(echo = TRUE, fig.align="center", collapse = TRUE, cache = TRUE)
set.seed(3000)
NameList<-read.csv("https://dl.dropboxusercontent.com/s/9iqim893uk5yjo9/Names.csv",header = FALSE,sep =",")
Name<-NameList[,1]
Name <- as.character(Name[1:10])
```
<br />

#Part 1: Data Display
##Table 1: Account
```{r generDataTable,echo=TRUE}
naccount <-10
id<- seq(1,naccount)
AcountNo <- str_pad(id,8,side = 'left',pad = '0') #formatting account number
#Creat Data Frame 1: Account
df1<- data.frame(AcountNo,Name)
datatable(df1, options = list(pageLength = 10, autoWidth = TRUE,columnDefs=list(list(className = 'dt-center',targets = 0),list(className = 'dt-left',targets = 1))),rownames = FALSE)

```


```{r generDataTable3,echo=TRUE,warning=FALSE}
#in this chart we create a Conversion Rate Table
library(quantmod)
currency = c("USD","CNY","SGD")
ConversionList = getFX(c("USD/SGD","CNY/SGD", "SGD/SGD"), from = "2017-07-01", to = "2017-09-30")
USD.SGD <- as.data.frame(USDSGD)
dateSeq<- row.names(USD.SGD)
Date<-dateSeq
#generate a table for currency conversion rate
df3 <- data.frame(dateSeq,USDSGD[,1],CNYSGD[,1],SGDSGD[,1])
Newtitle<-c('Date','USD/SGD Conversion','CNY/SGD Conversion','SGD/SGD Conversion')
colnames(df3)<-Newtitle
row.names(df3) = NULL
```


```{r generDeposit,echo=TRUE,warning=FALSE}
#define transaction of each account
#deposit times for each account in each month
#num of deposit of each account in each month(row means account,column means month)
transacnum <- matrix(round(runif((3*naccount),min=1,max=2)),naccount,3)
#to make it more realistic, deposit time can be 1 or 2 within each month
JulSeq<-dateSeq[1:31]
AugSeq<-dateSeq[32:62]
SepSeq<-dateSeq[63:92]
TransAccount <- list()
TransDate <- list()
DepositTable<-data.frame(transacnum)
MonthList <-c('Jul','Aug','Sep')
colnames(DepositTable)<-MonthList
#initialize dataframe
Date <- list()
Account <-list()
TransType <- list()
Amount <-list()
Cur <- list()
deposit<-data.frame(Date,Account,TransType,Amount,Cur)

#define Deposite function
DepositGenr <- function(oldtable,accountNum,Month){
  tmpAccount <- accountNum
  tmpType <- 'Deposit'
  tmpAmount <- round(runif(1,min=3000,max=5000),digits = 2)
  Cur <-round(runif(1,min=1,max=3))
  tmpCur <- currency[Cur]
  dateint <- round(runif(1,min=1,max =30))
  Date <- Month[dateint]
  df<-data.frame(Date,tmpAccount,tmpType,tmpAmount,tmpCur)
  df<-rbind(oldtable,df)
  df
}
#Generate deposit transaction for each account in each month
for (i in 1:naccount){
    NDeposit <- DepositTable[i,]
    for(j in 1:3){
      n <- NDeposit[j]
      mon <- dateSeq[(1+31*(j-1)):(31*j-1)]
      if(n!=0){
        deposit<-DepositGenr(deposit,i,mon)
      }
    }
}
deposit$Date<-as.Date(deposit$Date)
#initialize account deposit and credit
InitialDeposit <- {round(runif(naccount,min=5000,max=10000),digits = 2)}
InitialCredit <- round(runif(naccount,min=0,max=1000),digits=2)

deposit
InitialDeposit
InitialCredit
```


```{r CopyTransactionTable,echo=TRUE,warning=FALSE}
#format deposit table into Transaction table for following calculation
ndate<-length(dateSeq)
Account<-rep(0,ndate)
TransType<-rep(' ',ndate)
Amount<-rep(0,ndate)
Cur<-rep(' ',ndate)
dateSeq<-as.Date(dateSeq)
TransacTable <- data.frame(dateSeq,Account,TransType,Amount,Cur)
depDate <- deposit['Date']
TransacTable$TransType<-as.character(TransacTable$TransType)
TransacTable$Cur<-as.character(TransacTable$Cur)
deposit$tmpType<-as.character(deposit$tmpType)
deposit$tmpCur<-as.character(deposit$tmpCur)
#deposit$Date<-as.Date(deposit$Date)
for (i in 1:92){
  tmpd <- depDate[i,1]
  id <- which(dateSeq==tmpd)
  TransacTable[id,] <- deposit[i,]
}
TransacTable$dateSeq<-as.Date(TransacTable$dateSeq)

TransacTable
```


```{r GenerWithdraw,echo=TRUE,warning=FALSE}
#In this chut, we define a Withdraw transaction generating function,
#Then use this function generate Withdraws according to present balance calculated by Balance = sum(Deposite + Withdraw), where Deposit is negative value
generWithd <- function(oldtable,accountNum,Date)
{ tmpAmount=0
  tmpAccount <-accountNum
  tmpType <- as.character('Withdraw')
  #calculate balance
  df<-oldtable
  tmpdf1<-dplyr::filter(oldtable,(Account ==tmpAccount)&(dateSeq<=Date))
  if (!empty(tmpdf1)){
  totalBalance<-dplyr::filter(oldtable,(Account ==tmpAccount)&(dateSeq<=Date))%>%dplyr::filter((TransType=='Deposit')|(TransType=='Withdraw'))%>%select(c('Amount'))%>%sum()
  
  balance = -totalBalance-InitialDeposit[tmpAccount]
  tmpAmount <- round(runif(1,min=balance,max=0),digits=2)
  if(!is.na(tmpAmount)){
  if (tmpAmount < 0) {
  Cur <-round(runif(1,min=1,max=3))
  tmpCur <- as.character(currency[Cur])
  df<-data.frame(Date,tmpAccount,tmpType,tmpAmount,tmpCur)
  df$tmpType<-as.character(df$tmpType)
  df$tmpCur<-as.character(df$tmpCur)
  newTitle <- c('dateSeq','Account','TransType','Amount','Cur')
  colnames(df)<-newTitle
  df<-rbind(oldtable,df)
  df
  }}}
  df
}
dateSeq<-as.Date(dateSeq)

#loop
for (i in 1:ndate){
  today <- dateSeq[i]
  for (j in 1:10){
    account = j
    TransacTable<-generWithd(TransacTable,account,today)
  }
}
TransacTable
```


```{r GenerCredit,echo=TRUE,warning=FALSE}
#Similar to GenerWithdraw part, generate credit transaction with constraints of spend = sum(Balance + Credit), where Credit is negative value.
generCredit <- function(oldtable,accountNum,Date)
{ tmpAmount=0
  tmpAccount <- accountNum
  tmpType <- as.character('Spend')
  #calculate balance
  df<-oldtable
  tmpdf1<-dplyr::filter(oldtable,(Account ==tmpAccount)&(dateSeq<=Date))
  if (!empty(tmpdf1)){
  totalBalance<- tmpdf1%>%select(c('Amount'))%>%sum()
  balance = -totalBalance-InitialCredit[tmpAccount]-InitialDeposit[tmpAccount]
  tmpAmount <- round(runif(1,min=balance/5,max=0),digits=2)
  if(!is.na(tmpAmount)){
  if (tmpAmount < 0) {
  Cur <-round(runif(1,min=1,max=3))
  tmpCur <- as.character(currency[Cur])
  df<-data.frame(Date,tmpAccount,tmpType,tmpAmount,tmpCur)
  df$tmpType<-as.character(df$tmpType)
  df$tmpCur<-as.character(df$tmpCur)
  newTitle <- c('dateSeq','Account','TransType','Amount','Cur')
  colnames(df)<-newTitle
  df<-rbind(oldtable,df)
  df
  }}}
  df
}
dateSeq<-as.Date(dateSeq)

#loop for generator
for (i in 1:ndate){
  today <- dateSeq[i]
  for (j in 1:10){
    account = j
    TransacTable<-generCredit(TransacTable,account,today)
  }
}
#TransacTable
```
<br />

##Table 2: Transaction Table
```{r GenerTransactionTable,echo=TRUE}
#In this table we format Transactiontable constructed before and arrange transactions according to transaction date
TransTable<-dplyr::filter(TransacTable,(Account != 0))
TransTable<-TransTable%>% arrange(dateSeq)
TransactionNo <- seq(1,nrow(TransTable))
TransTable<-cbind(TransactionNo,TransTable)
newTitle <- c('TransactionNo','Date','AccountNo','TransactionType','Amount','Currency')
colnames(TransTable)<-newTitle
datatable(TransTable, options = list(pageLength = 10, autoWidth = TRUE),rownames = FALSE)
```

##Table 3: Conversion Rate
```{r display tb3,echo=TRUE}
#display conversion rate table constructed before
datatable(df3, options = list(pageLength = 10, autoWidth = TRUE),rownames = FALSE)
```

<br /><br />

#Part 2: Final Report
##Risk Department:
###1.Total Balance
```{r ReportBalance1,echo=TRUE}
#In this part,we calculate the total balance of bank accounts for each day
TransTable$Date<-as.Date(TransTable$Date)
BalanceTable<-dplyr::filter(TransTable,(TransactionType=='Deposit')|(TransactionType=='Withdraw'))%>%arrange(Date)%>%select(c('Date','Amount'))%>%group_by(Date)%>%dplyr::summarize(TotalBalance = round(sum(Amount)+sum(InitialDeposit)),digits=2)
datatable(BalanceTable, options = list(pageLength = 10, autoWidth = TRUE,
        columnDefs=list(list(className = 'dt-center',targets = 0:2))),rownames = FALSE)
```

###2. Total Receivable
```{r ReportReceivable,echo=TRUE}
#In this part,we calculate the total Receivable of bank accounts for each day
ReceivableTable<-dplyr::filter(TransTable,(TransactionType=='Spend'))%>%arrange(Date)%>%select(c('Date','Amount'))%>%group_by(Date)%>%dplyr::summarize(DailyReceivable =-(sum(Amount)))
RecTable<-data.frame(list(),list())
for (i in 1:nrow(ReceivableTable)){
  tmpdate <- ReceivableTable[[1]][i]
Sum<-dplyr::filter(ReceivableTable,Date<=tmpdate)%>%summarise(TotalReceivable = sum(DailyReceivable))
TotalReceivable <- Sum[1,1]+sum(InitialCredit)
  tmpdf<-data.frame(tmpdate,TotalReceivable)
  RecTable<-rbind(RecTable,tmpdf)
}

datatable(RecTable, options = list(pageLength = 10, autoWidth = TRUE,columnDefs=list(list(className = 'dt-center',targets = 0),list(className = 'dt-left',targets = 1))),rownames = FALSE,caption = "Total Receivable at End of a Month")
```

###3. Monthly Rank on Risk
####1) Top risk
```{r ReportRisk,echo=TRUE}
##In this part,we calculate the risk of each accounts at end of the month and rank
RiskTable<- mutate(TransTable,Month = format((as.Date(Date)),'%m'))%>%group_by(Month,AccountNo)%>%dplyr::summarize(TBalance = sum(Amount))%>%rowwise()%>%mutate(Risk =round(TBalance+InitialDeposit[AccountNo]-InitialCredit[AccountNo],digits =2) )%>%arrange(Month,-Risk)%>%select(c('Month','AccountNo','Risk'))
RiskTable %>%datatable(options = list(pageLength = 10, autoWidth = TRUE,columnDefs=list(list(className = 'dt-center',targets = 0:2))),rownames = FALSE,caption = "Top 10 Risk at end of month")
```

####2) Low risk
```{r ReportRiskL,echo=TRUE}
# similar to last one but using a different ranking direction
RiskTable<- mutate(TransTable,Month = format((as.Date(Date)),'%m'))%>%group_by(Month,AccountNo)%>%dplyr::summarize(TBalance = sum(Amount))%>%rowwise()%>%mutate(Risk =round(TBalance+InitialDeposit[AccountNo]-InitialCredit[AccountNo],digits =2) )%>%arrange(Month,Risk)%>%select(c('Month','AccountNo','Risk'))
datatable(RiskTable, options = list(pageLength = 10, autoWidth = TRUE,columnDefs=list(list(className = 'dt-center',targets = 0:2))),rownames = FALSE,caption = "Lowest 10 Risk at end of month")
```

##Customer Department:
###1. Top Balance
```{r ReportBalanceT,echo=TRUE}
#In this part,we calculate the total balance of each accounts for each end of month and ranks with the balance 
BalanceTable<- mutate(TransTable,Month = format((as.Date(Date)),'%m'))%>%dplyr::filter((TransactionType=='Deposit')|(TransactionType=='Withdraw'))%>%group_by(Month,AccountNo)%>%dplyr::summarize(TBalance = round(sum(Amount),digits=2))%>%arrange(Month,AccountNo)%>%mutate(TotalBalance=round(TBalance+InitialDeposit[AccountNo]),digits=2)%>%select(c('Month','AccountNo','TotalBalance'))%>% arrange(Month,-TotalBalance)
datatable(BalanceTable, options = list(pageLength = 10, autoWidth = TRUE,columnDefs=list(list(className = 'dt-center',targets = 0:2))),rownames = FALSE,caption = "Top 10 Balance at end of a month")
```

###2. Top Spending
```{r ReportSpendingT,echo=TRUE}
#In this part,we calculate the total spending of each accounts for each end of month and ranks with the spending(credit) 
SpendingTable<- mutate(TransTable,Month = format((as.Date(Date)),'%m'))%>%dplyr::filter(TransactionType=='Spend')%>%group_by(Month,AccountNo)%>%dplyr::summarize(TotalSpend = round(sum(Amount),digits =2))%>%arrange(Month,TotalSpend)
datatable(SpendingTable, options = list(pageLength = 10, autoWidth = TRUE,columnDefs=list(list(className = 'dt-center',targets = 0:2))),rownames = FALSE,caption = "Top 10 Spending at end of month")
```

###3. Top Saving
```{r ReportSaving,echo=TRUE}
SaveingTable<- mutate(TransTable,Month = format((as.Date(Date)),'%m'))%>%dplyr::filter(TransactionType=='Deposit')%>%group_by(Month,AccountNo)%>%dplyr::summarize(TotalSaving = round(sum(Amount),digits =2))%>%arrange(Month,-TotalSaving)
datatable(SaveingTable, options = list(pageLength = 10, autoWidth = TRUE,columnDefs=list(list(className = 'dt-center',targets = 0:2))),rownames = FALSE,caption = "Top 10 Saving at end of month")
```

##Treasury Department:
```{r ReportSpending,echo=TRUE}
#In this part,we calculate the total InterestReceivable
InterestTable<- mutate(TransTable,Month = format((as.Date(Date)),'%m'))%>%dplyr::filter(TransactionType=='Spend')%>%arrange(AccountNo)%>%mutate(Interest = (-1)*round(Amount * abs(exp(0.0025*as.numeric(as.Date("2017-09-30")-Date))-1),digits=2))%>%summarize(TotalInterest= round(sum(Interest),digits = 2))

datatable(InterestTable,class = 'hover',options = list(searching = FALSE,columnDefs=list(list(className = 'dt-left',targets = 0))),rownames = FALSE,caption = "Interest Receivable in total")
```


<br />

#Part 3: Client Information Table:
There're acutually more than 20 tables for Client end of month information.
In case this part costs too much time to generate tables, we only exhibit one table as an example here. We also provide a loop in the Markdown page where users can change the range of AccountNo and Month to check all the possible results of Client Information Table.
```{r Client,echo=TRUE}
#In this Part, we generate tables for detailed information on a specific account for each month.
#Loop for generating table and account information table.
#If want to check all tables, can use the alternative definition in documentation.(tmpAcc in 1:10);for (tmpMonth in 7:9)??print(p)
dateSeq=as.Date(dateSeq)
for(tmpAcc in 2:2){
#for(tmpAcc in 1:10){
  for (tmpMonth in 7:7){
  #for (tmpMonth in 7:9){
    month = seq(as.Date(paste0("2017-",tmpMonth,"-01")),as.Date(paste0("2017-",tmpMonth+1,"-01")),by = "day")
    Client1<- TransTable%>%dplyr::filter(AccountNo==tmpAcc)%>%arrange(Date)%>%dplyr::filter((Date>as.Date(month[1]))&(Date<as.Date(month[length(month)])))%>%select(c('Date','TransactionType','Amount','Currency'))
    if(!empty(Client1)){
    for (i in 1:nrow(Client1)){
    #  i=2
      tmpdate = Client1[i,'Date']
      tmpcurrency = Client1[i,'Currency']
      nrow <-which(dateSeq==tmpdate)
      crow <- which(currency==tmpcurrency)+1
      ASGD = df3[nrow,crow]*Client1[i,'Amount']
      Client1$AmountSGD[i] = round(ASGD,digits=2)
      if(i ==1) {Client1$DepositBalance[1]=InitialDeposit[tmpAcc]
      Client1$CreditBalance[1]=InitialCredit[tmpAcc]}
      if(i >1){ 
        if (Client1[i,'TransactionType']!="Spend")
        {Client1$DepositBalance[i]=Client1$DepositBalance[i-1]+Client1$AmountSGD[i]
        Client1$CreditBalance[i]=Client1$CreditBalance[i-1]}
        if (Client1[i,'TransactionType']=="Spend")        {Client1$DepositBalance[i]=Client1$DepositBalance[i-1]
    Client1$CreditBalance[i]=Client1$CreditBalance[i-1]+Client1$AmountSGD[i]}}}
    Client1<-Client1%>%add_row(DepositBalance = Client1$DepositBalance[nrow(Client1)], CreditBalance = Client1$CreditBalance[nrow(Client1)])
    ClientHeader = c(" " = 0,  " "  =3, " " = 4)
    MonthHeader = c(" " = 0, " " = 3, " " = 4)
    Header = c(" " = 0, " " = 6, " " = 1)
    names(ClientHeader) = c("Client Name: ", Name[tmpAcc]," ")
    names(MonthHeader) = c("Month: ",paste("0",tmpMonth)," ")
    names(Header) = c(" ",paste("Month-End Customer Report for No.",tmpAcc)," ")
    p<<-kable(Client1,"html") %>%kable_styling(bootstrap_options = c("striped", "hover", "condensed"))%>%
      add_header_above(header = MonthHeader) %>%
      add_header_above(header = ClientHeader) %>% 
      add_header_above(header = Header) %>%
      group_rows("Month End Balance ",nrow(Client1),nrow(Client1))
    #print(p)
    }
  }}
p

```
