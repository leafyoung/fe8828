---
title: "FE8828 Programming Web Applications in Finance"
subtitle: "<sub> Week 5 <br> Applications </sub>"
author: "Dr. Yang Ye <sub> <Email:yy@runchee.com> </sub>"
date: "Nov 30, 2017"
# runtime: shiny
---

```{r setup, include=FALSE}
library(fOptions)
library(tidyverse)
library(lubridate)
library(bizdays)
library(ggplot2)
library(ggthemes)
library(gridExtra)
library(maps)
library(knitr)
library(kableExtra)
knitr::opts_chunk$set(echo = FALSE, fig.align="center", collapse = TRUE, cache = TRUE)
chunk <- "```"
inline <- function(x = "") paste0("`` `r ", x, "` ``")
bank <- read.csv("https://goo.gl/PBQnBt", sep = ";")
token_qd <- 'JyeshGuNBGDbbaYoNURG'
token_av <- 'QWM66H05ENYFRDPO'
```
<style type="text/css">
code.r{ /* Code block */
    font-size: 20px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 17px;
}
</style>

# Lecture 10: Financial Application

# Starter

```{r echo = FALSE, comment = ""}
cat(htmltools::includeText("example/biorhythm.R"))
```

```{r, echo = F}
source("example/biorhythm.R")
```

# Main course

- We need following packages as a start. Use c() to install multiple packages.
      
    install.packages(c("tidyquant", "Quandl", "fOptions", "fExoticOptions", "dygraph", "forecast"))

- tidyquant is also a collection of packages: xts/quantmod

- Please validate option pricing code. I found Asian Option in `fExoticOptions` is strangely implemented.

# tidyquant or Quandl
Determining factor:

- tidyquant/quantmod can connect to various services: google, yahoo (retiring), av (AlphaAdvantage).
- Quandl only connects to Quandl
- It's subject where you can find the data.
    - US ETF on Quandl is premium. ETF in Google/AlphaAdvantage is free.

Technical details:

- quantmod returns `xts` object. Quandl returns data frame or `xts`
- quantmod use assign to create variable. Quandl returns an object
- xts can `collapse` to daily, weekly, monthly.

# Tidyquant/quantmod

```{r, echo = T}
library(tidyquant)

# use Google
getSymbols('SPY', src = 'google', adjusted = TRUE, output.size = 'full')
str(SPY)

# Sign up with AlphaAdvantage to get a token
getSymbols('SPY', src = 'av', adjusted = TRUE, output.size = 'full', api.key = token_av)
str(SPY)

head(SPY)
tail(SPY)

symbols <- c("MSFT", "AAPL")
getSymbols(symbols, src = 'google', adjusted = TRUE, from = "2016-01-01")

```

# `xts` object
- xts is a wide format. In contrast, ggplot/tidy uses long format.
- We have gather/spread to convert between long/wide format.
- Create xts object: put index, date usually, aside, and store prices in columns.

        library(xts)    
        # if df is a data frame.
        # Date | V | GS
        xts1 <- xts(x=df[, -1, drop = F], order.by = df[1])

        # coredata: returns a matrix from xts objects
        # index: vector of any Date, POSIXct, chron, yearmon, yearqtr, or DateTime classes
        core_data <- coredata(xts2)
        index(xts1)

# Get data from `xts` object

```{r, echo = T}
str(SPY)
```

```{r, echo = T, results = "hide"}
SPY2003 <- SPY["2003"]
SPY2 <- SPY["2003/2007"]
SPY3 <- SPY["2003-03-01/2007-07-01"]
SPY4 <- SPY["/2007-07-01"]
SPY5 <- SPY["2007-07-01/"]
SPY6 <- SPY["2007-07-01/", "SPY.High"]
SPY6 <- SPY["2007-07-01/", "SPY.High/SPY.Close"]
```

# Quandl
```{r, echo = T}
library(Quandl)
library(tidyverse)

# Sign up with Quandl to get a token
# token <- "xxxx"
Quandl.api_key(token_qd)
# You don't get SPY: SPDR 500 ETF
rates <- Quandl(c("EOD/SPY"), start_date="2000-01-01", end_date="2013-06-07")
# You get price for Visa
rates <- Quandl(c("EOD/V"), start_date="2000-01-01", end_date="2013-06-07" )
# Get price for Visa in xts
rates <- Quandl(c("EOD/V"), start_date="2000-01-01", end_date="2013-06-07", type = "xts")
```

# Quandl
```{r, echo = T}
library(Quandl)					# Quandl package
library(ggplot2)				# Package for plotting
library(tidyverse)				# Package for reshaping data

Quandl.api_key(token_qd)				# Authenticate your token
# Build vector of currencies
rates <- Quandl(c("FRED/DEXUSAL", "FRED/DEXBZUS", "FRED/DEXUSUK", "FRED/DEXCHUS"),start_date="2000-01-01",end_date = "2017-11-30")
colnames(rates) <- c("Date", "AUD/USD", "USD/BRL", "GBP/USD", "USD/CNY")
meltdf <- gather(rates, key = "CCY", value = "Rate", -Date)

ggplot(meltdf, aes(x = Date, y = value, colour = CCY, group = CCY)) +
  geom_line() +
  scale_colour_manual(values=1:22)+
  ggtitle("Major Currency Exchange Rates in USD") +
  theme_minimal()
```

# Quandl and forecast

```{r, echo = T}
cat(htmltools::includeText("example/52-quandl-forecast.R"))
```

```{r, echo = F}
source("example/52-quandl-forecast.R")
```

# dygraph

dygraph for xts
https://rstudio.github.io/dygraphs/shiny.html

    dygraphOutput("dygraph")

    dygraph(oil_combined_xts, main = "Oil Prices: Historical and Forecast") %>%
      # Add the actual series
      dySeries("Actual", label = "Actual") %>%
      # Add the three forecasted series
      dySeries(c("Lo_95", "Forecast", "Hi_95"))

# Quandl/Shiny/dygraph

```{r, echo = T}
cat(htmltools::includeText("example/shiny-51-quandl.R"))
```

# Portfolio analysis

```{r, echo = T}
cat(htmltools::includeText("example/53-portfolio-2.R"))
```

# Assingment
Part II

1. Bank management 
- We also need to generate following monthly reports:
    - Risk department: Total balance, Total receivable from credit, Top 10 High and low-risk client (i.e. balance - spent credit).
    - Customer department: Top 10 balance customer, Top 10 spending customer, Top 10 saving customer.
    - Treasury department: Interest rate payable monthly, assume annual interest is 0.25%.

2. Delta Hedging
Show case how delta hedging works as a trading strategy.

- Show how one trade works
- Backtest for available history.

Assumption:

- You hold 100 ATM call/put option which expires in 30 days (calendar days). You just need to do either Call or Put.
- You start to do delta hedging daily immediately till 2nd last day. You close stock position in the last day.
- Delta hedging: calculate the delta from option, negate it, that's the quantity what you need to hold over 1 day. Repeat for every trading day.
- Daily PnL: (option premium change) + (stock holding quantity * price change).

- You can get your favorite stocks here. There is one year of data.
  https://marketchameleon.com/Overview/{Stock Code}/DailyHistory/
  https://marketchameleon.com/Overview/GS/DailyHistory/
- Daily IV30 is provided.
- As underlying is equity, dividend yield is applicable for B-S valuation
- US risk-free rate for 1M: 0.8% (annualized)

For one trade

- Daily PnL v.s. Time to expiry: split into option and stock.  
- Final PnL: accumulative of Daily PnL. split into option and stock
- Max Drawdown: accumulative of Daily PnL, max - min.
- Sharpe ratio: Sharpe ratio = (Mean of Daily PnL âˆ’ Risk-free rate)/Standard deviation of Daily PnL

For backtest:

- Distribution of Final PnL
- Distribution of Max Drawdown
- Final PnL v.s. Option Expiry Date
- ...

- in R Markdown
